<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reparaturauftrag - IBG HydroTech</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-blue: #005293;
            --secondary-blue: #007bc0;
            --accent-orange: #e37222;
            --light-gray: #f5f5f5;
            --medium-gray: #e0e0e0;
            --dark-gray: #333;
            --text-gray: #666;
            --white: #ffffff;
            --success-green: #28a745;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f0f2f5 0%, #e6e9f0 100%);
            color: var(--dark-gray);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(to right, var(--primary-blue), var(--secondary-blue));
            color: var(--white);
            padding: 2rem;
            text-align: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }
        
        .logo-icon {
            font-size: 2.5rem;
            margin-right: 15px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .content {
            padding: 2rem;
        }
        
        .section {
            margin-bottom: 2.5rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--medium-gray);
        }
        
        .section:last-child {
            border-bottom: none;
        }
        
        .section-title {
            color: var(--primary-blue);
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent-orange);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: var(--accent-orange);
        }
        
        /* STYLE FÜR DYNAMISCHE CHECKBOXEN (initial versteckt) */
        .dynamic-checkboxes {
            display: none;
        }
        
        .dynamic-checkboxes.visible {
            display: block;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1rem;
        }
        
        
        /* Abnahmeprotokoll: Prüfinfo-Zeile (2 breite Felder + Anmerkungen bis rechts) */
        .form-grid.abnahme-grid {
            grid-template-columns: 1fr 1fr 2fr;
        }
        .abnahme-grid .span-2 {
            grid-column: span 2;
        }
.form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        label {
            font-weight: bold;
            color: var(--primary-blue);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        label i {
            color: var(--accent-orange);
        }
        
        input[type="text"],
        input[type="date"],
        input[type="number"],
        input[type="checkbox"],
        textarea {
            padding: 1rem 1.2rem;
            border: 2px solid var(--medium-gray);
            border-radius: 8px;
            font-size: 1.1rem;
            transition: all 0.3s;
            background: var(--white);
            width: 100%;
        }
        
        input[type="checkbox"] {
            width: auto;
            padding: 0;
            margin-right: 0.5rem;
        }
        
        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--secondary-blue);
            box-shadow: 0 0 0 3px rgba(0, 114, 192, 0.2);
            transform: translateY(-2px);
        }
        
        textarea {
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
            border-radius: 8px;
            border: 1px solid var(--medium-gray);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
        }
        
        thead {
            background: linear-gradient(to right, var(--primary-blue), var(--secondary-blue));
            color: var(--white);
        }
        
        th {
            padding: 1.2rem 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 1.1rem;
            white-space: nowrap;
        }
        
        tbody tr {
            border-bottom: 1px solid var(--medium-gray);
            transition: background-color 0.3s;
        }
        
        tbody tr:hover {
            background-color: rgba(0, 82, 147, 0.05);
        }
        
        td {
            padding: 1rem;
            vertical-align: top;
        }
        
        td input {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--medium-gray);
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .button-container {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 2rem;
        }
        
        button {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(to right, var(--primary-blue), var(--secondary-blue));
            color: var(--white);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 82, 147, 0.3);
        }
        
        .btn-success {
            background: var(--success-green);
            color: var(--white);
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: var(--text-gray);
            color: var(--white);
        }
        
        .btn-secondary:hover {
            background: #555;
        }
        
        .edit-btn {
            background: var(--secondary-blue);
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .status-checkboxes {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .status-checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: normal;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 25px;
            background: var(--medium-gray);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(to right, var(--success-green), #20c997);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            transition: width 0.3s;
        }
        
        .progress-text {
            font-size: 0.9rem;
            color: var(--text-gray);
            text-align: center;
        }
        
        .task-checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .task-checkbox-item:hover {
            background: rgba(0, 82, 147, 0.05);
        }
        
        .task-checkbox-item.completed {
            background: rgba(40, 167, 69, 0.1);
        }
        
        .task-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        .task-checkbox-item label {
            flex: 1;
            font-weight: normal;
        }
        
        #work-tasks-container {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--light-gray);
            border-radius: 8px;
        }
        
        #empty-orders {
            text-align: center;
            padding: 3rem;
            color: var(--text-gray);
        }

        /* ---------- Checkbox-Karten (einheitliches Design) ---------- */
        .section-divider {
            border-top: 2px solid var(--medium-gray);
            margin: 1.2rem 0 1.6rem 0;
            width: 100%;
        }

        .checkbox-grid {
            gap: 1rem;
        }

        /* Checkbox-Optik + Rahmen + leichter Blauschimmer */
        .checkbox-card {
            display: flex;
            align-items: center;
            gap: 0.7rem;
            padding: 0.9rem 1rem;
            border: 1.5px solid var(--medium-gray);
            border-radius: 10px;
            background: rgba(0, 123, 192, 0.14); /* sehr helles, fast transparentes Blau */
            transition: all 0.2s ease;
            min-height: 52px;
        }

        .checkbox-card:hover {
            border-color: rgba(0, 123, 192, 0.45);
            transform: translateY(-1px);
        }

        .checkbox-card input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin: 0;
        }

        .checkbox-card span {
            font-weight: 600;
            color: var(--dark-gray);
        }

        /* "Sonstiges" als Inline-Textbox innerhalb der gleichen Grid-Zeile */
        .checkbox-card.other-inline {
            gap: 0.9rem;
        }

        .checkbox-card.other-inline .other-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
            color: var(--primary-blue);
            white-space: nowrap;
        }

        .checkbox-card.other-inline input[type="text"] {
            flex: 1;
            padding: 0.8rem 0.9rem;
            border: 1.5px solid var(--medium-gray);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--white);
        }

        /* Auftragsliste: Sortierung + Filter (ohne Layout-Bruch) */
        th.sortable {
            cursor: pointer;
            user-select: none;
        }
        th.sortable .sort-indicator {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .filter-row th {
            padding: 0.6rem 1rem;
            background: var(--white);
        }
        .filter-row input {
            width: 100%;
            padding: 0.55rem 0.6rem;
            border: 1px solid var(--medium-gray);
            border-radius: 6px;
            font-size: 0.95rem;
        }
        .filter-row input:focus {
            outline: none;
            border-color: var(--secondary-blue);
            box-shadow: 0 0 0 3px rgba(0, 114, 192, 0.2);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .button-container {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }
    
        /* Labels unter Inputs (Abnahmeprotokoll) */
        .below-label {
            display: block;
            margin-top: 6px;
            font-weight: 700;
            color: var(--primary-blue);
            font-size: 0.95rem;
        }

</style>
</head>
<body>
    <div id="main-container" class="container">
        <header>
            <div class="logo">
                <i class="fas fa-tools logo-icon"></i>
                <div>
                    <h1>IBG HYDROTECH</h1>
                    <p class="subtitle">Reparaturauftrag</p>
                </div>
            </div>
        </header>

        <div class="content">
            <input type="hidden" id="order-id">
            
            <!-- Auftragsstammdaten Section -->
            <div class="section">
                <h2 class="section-title">
                    <i class="fas fa-file-alt"></i>
                    Auftragsstammdaten
                </h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label><i class="fas fa-hashtag"></i> Vorgang</label>
                        <input type="text" id="vorgang" placeholder="z.B. 2024-001">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-building"></i> Kunde</label>
                        <input type="text" id="customer" placeholder="Kundenname">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> Eingangsdatum</label>
                        <input type="date" id="entry-date">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-tag"></i> Betrifft</label>
                        <input type="text" id="subject" placeholder="Gerätetyp/Modell">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-barcode"></i> Seriennummer</label>
                        <input type="text" id="serial-number" placeholder="Seriennummer">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Name (Bearbeiter)</label>
                        <input type="text" id="name" placeholder="Ihr Name">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-clock"></i> Stunden</label>
                        <input type="number" id="hours" placeholder="0" min="0" step="0.5">
                    </div>
                </div>

                <div class="section-divider"></div>
                
                <!-- NEUE SEKTION: Mitgeliefertes Zubehör -->
                <div class="form-group full-width">
                    <label><i class="fas fa-box"></i> Mitgeliefertes Zubehör</label>
                    <div class="form-grid checkbox-grid">
                        <label class="checkbox-card">
                            <input type="checkbox" id="zubehoer-hintere-kamera" onchange="updateDynamicCheckboxes()">
                            <span>Hintere Kamera</span>
                        </label>

                        <label class="checkbox-card">
                            <input type="checkbox" id="zubehoer-drehkamera" onchange="updateDynamicCheckboxes()">
                            <span>Drehkamera</span>
                        </label>

                        <label class="checkbox-card">
                            <input type="checkbox" id="zubehoer-steuerkoffer" onchange="updateDynamicCheckboxes()">
                            <span>Steuerkoffer</span>
                        </label>

                        <div class="checkbox-card other-inline">
                            <span class="other-label"><i class="fas fa-edit"></i> Sonstiges</span>
                            <input type="text" id="zubehoer-sonstiges" placeholder="Weiteres Zubehör">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fehleranalyse Section -->
            <div class="section">
                <h2 class="section-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    Fehleranalyse
                </h2>
                
                <!-- NEUE SEKTION: Funktionsüberprüfung bei Annahme -->
                <div class="form-group full-width">
                    <label><i class="fas fa-clipboard-check"></i> Funktionsüberprüfung bei Annahme</label>
                    <div class="form-grid checkbox-grid">
                        <label class="checkbox-card">
                            <input type="checkbox" id="funktion-fahren">
                            <span>Fahren</span>
                        </label>
                        <label class="checkbox-card">
                            <input type="checkbox" id="funktion-heben">
                            <span>Heben</span>
                        </label>
                        <label class="checkbox-card">
                            <input type="checkbox" id="funktion-drehen">
                            <span>Drehen</span>
                        </label>
                        <label class="checkbox-card">
                            <input type="checkbox" id="funktion-fraeskopf-schwenken">
                            <span>Fräskopf schwenken (HC200)</span>
                        </label>
                        <label class="checkbox-card">
                            <input type="checkbox" id="funktion-fraesen">
                            <span>Fräsen</span>
                        </label>
                        <label class="checkbox-card">
                            <input type="checkbox" id="funktion-spuelen">
                            <span>Spülen</span>
                        </label>
                    </div>
                </div>
                
                <!-- Dynamische Kamera-Funktionsprüfungen (nur sichtbar wenn Kamera/Steuerkoffer gewählt) -->
                <div id="kamera-funktionen" class="dynamic-checkboxes">
                    <div class="form-group full-width">
                        <label><i class="fas fa-video"></i> Kamera-Funktionen</label>
                        <div class="form-grid checkbox-grid">
                            <label class="checkbox-card">
                                <input type="checkbox" id="funktion-bild-hintere">
                                <span>Bild hintere Kamera</span>
                            </label>
                            <label class="checkbox-card">
                                <input type="checkbox" id="funktion-led-hintere">
                                <span>LED hintere Kamera</span>
                            </label>
                            <label class="checkbox-card">
                                <input type="checkbox" id="funktion-bild-dreh">
                                <span>Bild Drehkamera</span>
                            </label>
                            <label class="checkbox-card">
                                <input type="checkbox" id="funktion-led-dreh">
                                <span>LED Drehkamera</span>
                            </label>
                            <label class="checkbox-card">
                                <input type="checkbox" id="funktion-kamera-umschalten">
                                <span>Kamerabild umschalten</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="section-divider"></div>
                
                <div class="form-group full-width" style="margin-top: 1.5rem;">
                    <label><i class="fas fa-file-medical-alt"></i> Fehlerbeschreibung</label>
                    <textarea id="error-description" placeholder="Detaillierte Beschreibung des Fehlers..."></textarea>
                </div>
            </div>

            <!-- Arbeitsaufgaben Section -->
            <div class="section">
                <h2 class="section-title">
                    <i class="fas fa-tasks"></i>
                    Arbeitsaufgaben
                </h2>
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label><i class="fas fa-wrench"></i> Durchzuführende Arbeiten</label>
                        <textarea id="work-todo" placeholder="Beschreibung der durchzuführenden Arbeiten..." onblur="generateTaskCheckboxes()"></textarea>
                    </div>

                    <div id="work-tasks-container" class="full-width">
                        <h3 style="color: var(--primary-blue); margin-bottom: 1rem;">Aufgaben-Checkliste</h3>
                        <div id="work-tasks-list"></div>
                    </div>
                </div>
</div>

            <!-- Ersatzteile Section -->
            <div class="section">
                <h2 class="section-title">
                    <i class="fas fa-cogs"></i>
                    Benötigte Ersatzteile
                </h2>
                <div class="form-grid">
                    <div class="full-width">

                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Artikelnummer</th>
                                <th>Beschreibung</th>
                                <th>Menge</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <tr>
                                <td><input type="text"></td>
                                <td><input type="text"></td>
                                <td><input type="text"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                
                <div style="margin-top: 1rem;">
                    <button class="btn-secondary" onclick="addRow()">
                        <i class="fas fa-plus"></i> Zeile hinzufügen
                    </button>
                </div>
                    </div>
                </div>
            </div>

            <div class="section-divider"></div>

            <!-- Abnahmeprotokoll Section -->
            <div class="section">
                <h2 class="section-title">
                    <i class="fas fa-clipboard-list"></i>
                    Abnahmeprotokoll vor Auslieferung
                </h2>

                <div class="form-grid checkbox-grid">
                    <label class="checkbox-card">
                        <input type="checkbox" id="abnahme-dichtigkeit">
                        <span>Dichtigkeitstest im Wasserbad durchgeführt</span>
                    </label>
                    <label class="checkbox-card">
                        <input type="checkbox" id="abnahme-fahren">
                        <span>Fahren getestet</span>
                    </label>
                    <label class="checkbox-card">
                        <input type="checkbox" id="abnahme-drehen">
                        <span>Drehen getestet</span>
                    </label>
                    <label class="checkbox-card">
                        <input type="checkbox" id="abnahme-heben">
                        <span>Heben getestet</span>
                    </label>
                    <label class="checkbox-card">
                        <input type="checkbox" id="abnahme-fraesen-real">
                        <span>Unter realen Bedingungen gefräst</span>
                    </label>
                </div>

                <div class="form-grid abnahme-grid" style="margin-top: 1rem;">
                    <div class="form-group">
                        <input type="date" id="abnahme-pruefdatum">
                        <label class="below-label" for="abnahme-pruefdatum">Prüfdatum</label>
                    </div>
                    <div class="form-group">
                        <input type="text" id="abnahme-pruefer">
                        <label class="below-label" for="abnahme-pruefer">Name Prüfer</label>
                    </div>
                    <div class="form-group span-2">
                        <input type="text" id="abnahme-anmerkungen">
                        <label class="below-label" for="abnahme-anmerkungen">Anmerkungen</label>
                    </div>
                </div>
            </div>


            <!-- Action Buttons -->
            <div class="button-container">
                <button class="btn-primary" onclick="saveOrder()">
                    <i class="fas fa-save"></i> Speichern
                </button>
                <button class="btn-success" onclick="saveAndGeneratePDF()">
                    <i class="fas fa-file-pdf"></i> PDF erstellen
                </button>
                <button class="btn-secondary" onclick="showOrdersList()">
                    <i class="fas fa-list"></i> Aufträge anzeigen
                </button>
                <button class="btn-secondary" onclick="resetForm()">
                    <i class="fas fa-redo"></i> Neuer Auftrag
                </button>
            </div>
        </div>
    </div>

    <!-- Orders List Container -->
    <div id="orders-container" class="container" style="display: none;">
        <header>
            <div class="logo">
                <i class="fas fa-list-alt logo-icon"></i>
                <div>
                    <h1>AUFTRAGSÜBERSICHT</h1>
                    <p class="subtitle">Alle Reparaturaufträge</p>
                </div>
            </div>
        </header>
        
        <div class="content">
            <div style="margin-bottom: 1.5rem;">
                <button class="btn-primary" onclick="backToForm()">
                    <i class="fas fa-arrow-left"></i> Zurück zum Formular
                </button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" data-key="vorgang">Vorgang <span class="sort-indicator"></span></th>
                            <th class="sortable" data-key="customer">Kunde <span class="sort-indicator"></span></th>
                            <th class="sortable" data-key="entryDate">Datum <span class="sort-indicator"></span></th>
                            <th class="sortable" data-key="subject">Betrifft <span class="sort-indicator"></span></th>
                            <th class="sortable" data-key="serialNumber">Seriennummer <span class="sort-indicator"></span></th>
                            <th class="sortable" data-key="progress">Fortschritt <span class="sort-indicator"></span></th>
                            <th class="sortable" data-key="statusText">Status <span class="sort-indicator"></span></th>
                            <th>Aktionen</th>
                        </tr>
                        <tr class="filter-row">
                            <th><input type="text" id="filter-vorgang" placeholder="Filtern..."></th>
                            <th><input type="text" id="filter-customer" placeholder="Filtern..."></th>
                            <th><input type="text" id="filter-entryDate" placeholder="dd.mm.yyyy"></th>
                            <th><input type="text" id="filter-subject" placeholder="Filtern..."></th>
                            <th><input type="text" id="filter-serialNumber" placeholder="Filtern..."></th>
                            <th></th>
                            <th></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="orders-body"></tbody>
                </table>
            </div>
            
            <div id="empty-orders">
                <i class="fas fa-inbox" style="font-size: 3rem; color: var(--medium-gray);"></i>
                <p style="margin-top: 1rem;">Keine Aufträge vorhanden</p>
            </div>
        </div>
    </div>

    <script>
        let ordersDatabase = [];
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzGBS0zcRjGYKMjkZxQ0WB50iPrcH3360ln4YZdpmL3jSn7ZeFq4VQKRkLa2WSgoQKE/exec';
        const CLOUD_ENABLED = true;
        
        // Zustand für Filter/Sortierung der Auftragsliste
        const ordersListState = {
            sortKey: 'entryDate',
            sortDir: 'desc',
            filters: {
                vorgang: '',
                customer: '',
                entryDate: '',
                subject: '',
                serialNumber: ''
            }
        };

        
        // ============================================
        // NEUE FUNKTION: Dynamische Checkboxen anzeigen/verstecken
        // ============================================
        function updateDynamicCheckboxes() {
            const hintereKamera = document.getElementById('zubehoer-hintere-kamera').checked;
            const drehkamera = document.getElementById('zubehoer-drehkamera').checked;
            const steuerkoffer = document.getElementById('zubehoer-steuerkoffer').checked;
            
            const kameraFunktionen = document.getElementById('kamera-funktionen');
            
            // Zeige Kamera-Funktionen wenn mindestens eine Kamera ODER Steuerkoffer gewählt wurde
            if (hintereKamera || drehkamera || steuerkoffer) {
                kameraFunktionen.classList.add('visible');
            } else {
                kameraFunktionen.classList.remove('visible');
            }
        }
        
        function addRow() {
            const tableBody = document.getElementById('table-body');
            const newRow = tableBody.insertRow();
            newRow.innerHTML = `
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
            `;
        }
        
        function generateTaskCheckboxes() {
            const workTodo = document.getElementById('work-todo').value.trim();
            const container = document.getElementById('work-tasks-container');
            const list = document.getElementById('work-tasks-list');
            
            if (!workTodo) {
                container.style.display = 'none';
                return;
            }
            
            const tasks = workTodo.split('\n').filter(t => t.trim());
            if (tasks.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            list.innerHTML = '';
            
            tasks.forEach((task, index) => {
                const div = document.createElement('div');
                div.className = 'task-checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" id="task-${index}" onchange="toggleTaskCompletion(${index})">
                    <label for="task-${index}">${task}</label>
                `;
                list.appendChild(div);
            });
        }
        
        window.toggleTaskCompletion = function(index) {
            const checkbox = document.getElementById(`task-${index}`);
            const item = checkbox.closest('.task-checkbox-item');
            if (checkbox.checked) {
                item.classList.add('completed');
            } else {
                item.classList.remove('completed');
            }
        };
        
        function saveOrder() {
            const data = collectFormData();
            if (!validateOrderData(data)) return;
            
            saveOrderToDatabase(data);
            alert('Auftrag erfolgreich gespeichert!');
            resetForm();
        }
        
        function saveAndGeneratePDF() {
            const data = collectFormData();
            if (!validateOrderData(data)) return;
            
            saveOrderToDatabase(data);
            generatePDF(data);
            alert('Auftrag gespeichert und PDF erstellt!');
        }
        
        function showOrdersList() {
            loadOrdersList();
            document.getElementById('main-container').style.display = 'none';
            document.getElementById('orders-container').style.display = 'block';
        }
        
        function backToForm() {
            document.getElementById('orders-container').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
        }
        
        // ============================================
        // ERWEITERTE collectFormData() Funktion
        // ============================================
        function collectFormData() {
            const workTodoText = document.getElementById('work-todo').value.trim();
            const tasks = workTodoText.split('\n').filter(t => t.trim());
            const workTasks = tasks.map((task, i) => ({
                task: task,
                completed: document.getElementById(`task-${i}`)?.checked || false
            }));
            
            const data = {
                id: document.getElementById('order-id').value || `order-${Date.now()}`,
                vorgang: document.getElementById('vorgang').value,
                customer: document.getElementById('customer').value,
                entryDate: document.getElementById('entry-date').value,
                subject: document.getElementById('subject').value,
                serialNumber: document.getElementById('serial-number').value,
                name: document.getElementById('name').value,
                hours: parseFloat(document.getElementById('hours').value) || 0,
                errorDescription: document.getElementById('error-description').value,
                workTodo: workTodoText,
                workTasks: workTasks,
                parts: [],
                
                // NEUE FELDER: Zubehör
                accessories: {
                    hintereKamera: document.getElementById('zubehoer-hintere-kamera').checked,
                    drehkamera: document.getElementById('zubehoer-drehkamera').checked,
                    steuerkoffer: document.getElementById('zubehoer-steuerkoffer').checked,
                    sonstiges: document.getElementById('zubehoer-sonstiges').value
                },
                
                // NEUE FELDER: Funktionsprüfung
                functionTests: {
                    fahren: document.getElementById('funktion-fahren').checked,
                    heben: document.getElementById('funktion-heben').checked,
                    drehen: document.getElementById('funktion-drehen').checked,
                    fraeskopfSchwenken: document.getElementById('funktion-fraeskopf-schwenken').checked,
                    fraesen: document.getElementById('funktion-fraesen').checked,
                    spuelen: document.getElementById('funktion-spuelen').checked,
                    bildHintere: document.getElementById('funktion-bild-hintere').checked,
                    ledHintere: document.getElementById('funktion-led-hintere').checked,
                    bildDreh: document.getElementById('funktion-bild-dreh').checked,
                    ledDreh: document.getElementById('funktion-led-dreh').checked,
                    kameraUmschalten: document.getElementById('funktion-kamera-umschalten').checked
                },

                // NEUE FELDER: Abnahmeprotokoll
                acceptanceProtocol: {
                    dichtigkeitstest: document.getElementById('abnahme-dichtigkeit').checked,
                    fahrenGetestet: document.getElementById('abnahme-fahren').checked,
                    drehenGetestet: document.getElementById('abnahme-drehen').checked,
                    hebenGetestet: document.getElementById('abnahme-heben').checked,
                    fraesenReal: document.getElementById('abnahme-fraesen-real').checked,
                    pruefdatum: document.getElementById('abnahme-pruefdatum').value || '',
                    pruefer: document.getElementById('abnahme-pruefer').value || '',
                    anmerkungen: document.getElementById('abnahme-anmerkungen').value || ''
                },

                status: ordersDatabase.find(o => String(o.id) === String(data.id))?.status || {}
            };
            
            document.querySelectorAll('#table-body tr').forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0].value.trim() || inputs[1].value.trim() || inputs[2].value.trim()) {
                    data.parts.push({
                        articleNumber: inputs[0].value.trim(),
                        description: inputs[1].value.trim(),
                        quantity: inputs[2].value.trim()
                    });
                }
            });
            
            return data;
        }
        
        function validateOrderData(data) {
            if (!data.vorgang || !data.customer || !data.subject || !data.name) {
                alert('Bitte alle Pflichtfelder (Vorgang, Kunde, Betrifft, Name) ausfüllen!');
                return false;
            }
            return true;
        }
        
        function saveOrderToDatabase(data) {
            const existingIndex = ordersDatabase.findIndex(o => String(o.id) === String(data.id));
            if (existingIndex !== -1) {
                ordersDatabase[existingIndex] = data;
            } else {
                ordersDatabase.push(data);
            }
            localStorage.setItem('ibgOrdersDatabase', JSON.stringify(ordersDatabase));
            syncOrderToCloud(data);
        }
        
        function loadOrdersList() {
            ordersDatabase = JSON.parse(localStorage.getItem('ibgOrdersDatabase')) || [];
            // Cloud-Refresh (falls aktiviert)
            if (CLOUD_ENABLED) {
                return fetchOrdersFromCloudAndMerge()
                    .then(() => applyFiltersAndRender())
                    .catch(() => applyFiltersAndRender());
            }
            applyFiltersAndRender();
        }

        async function fetchOrdersFromCloudAndMerge() {
            if (!GOOGLE_SCRIPT_URL) return;
            const res = await fetch(GOOGLE_SCRIPT_URL, { method: 'GET' });
            if (!res.ok) throw new Error('Cloud-GET fehlgeschlagen');
            const cloudOrders = await res.json();
            if (!Array.isArray(cloudOrders)) return;

            // Merge: Cloud gewinnt bei gleicher ID
            const byId = new Map((ordersDatabase || []).map(o => [String(o.id), o]));
            cloudOrders.forEach(o => byId.set(String(o.id), o));
            ordersDatabase = Array.from(byId.values());

            localStorage.setItem('ibgOrdersDatabase', JSON.stringify(ordersDatabase));
        }

        function getProgress(order) {
            if (order.workTasks?.length > 0) {
                const comp = order.workTasks.filter(t => t.completed).length;
                const pct = Math.round((comp / order.workTasks.length) * 100);
                return { pct, text: `${comp}/${order.workTasks.length} erledigt` };
            }
            return { pct: 0, text: 'Keine Aufgaben' };
        }

        function getStatusText(order) {
            const s = order.status || {};
            const tags = [];
            if (s.auftragErteilt) tags.push('Auftrag erteilt');
            if (s.reparaturAbgeschlossen) tags.push('Abgeschlossen');
            if (s.versendetAnKunden) tags.push('Versendet');
            return tags.join(' • ');
        }

        function normalizeString(v) {
            return (v ?? '').toString().toLowerCase().trim();
        }

        function applyFiltersAndSort(orders) {
            const f = ordersListState.filters;

            const filtered = (orders || []).filter(o => {
                const dateStr = o.entryDate ? new Date(o.entryDate).toLocaleDateString('de-DE', { day:'2-digit', month:'2-digit', year:'numeric'}) : '';
                return (
                    normalizeString(o.vorgang).includes(normalizeString(f.vorgang)) &&
                    normalizeString(o.customer).includes(normalizeString(f.customer)) &&
                    normalizeString(dateStr).includes(normalizeString(f.entryDate)) &&
                    normalizeString(o.subject).includes(normalizeString(f.subject)) &&
                    normalizeString(o.serialNumber).includes(normalizeString(f.serialNumber))
                );
            });

            const key = ordersListState.sortKey;
            const dir = ordersListState.sortDir === 'asc' ? 1 : -1;

            const sorted = [...filtered].sort((a, b) => {
                // Sonderkeys
                if (key === 'progress') {
                    return (getProgress(a).pct - getProgress(b).pct) * dir;
                }
                if (key === 'statusText') {
                    return getStatusText(a).localeCompare(getStatusText(b), 'de', { sensitivity: 'base' }) * dir;
                }
                if (key === 'entryDate') {
                    const da = a.entryDate ? new Date(a.entryDate).getTime() : 0;
                    const db = b.entryDate ? new Date(b.entryDate).getTime() : 0;
                    return (da - db) * dir;
                }
                const va = (a[key] ?? '').toString();
                const vb = (b[key] ?? '').toString();
                // numeric fallback
                const na = Number(va.replace(',', '.'));
                const nb = Number(vb.replace(',', '.'));
                if (!Number.isNaN(na) && !Number.isNaN(nb) && (va.trim() !== '' || vb.trim() !== '')) {
                    return (na - nb) * dir;
                }
                return va.localeCompare(vb, 'de', { sensitivity: 'base' }) * dir;
            });

            return sorted;
        }

        function updateSortIndicators() {
            document.querySelectorAll('#orders-container th.sortable').forEach(th => {
                const span = th.querySelector('.sort-indicator');
                if (!span) return;
                const k = th.getAttribute('data-key');
                if (k === ordersListState.sortKey) {
                    span.textContent = ordersListState.sortDir === 'asc' ? '▲' : '▼';
                } else {
                    span.textContent = '';
                }
            });
        }

        function applyFiltersAndRender() {
            const viewOrders = applyFiltersAndSort(ordersDatabase);
            updateSortIndicators();
            renderOrdersTable(viewOrders);
        }

        function initOrdersListControls() {
            const bind = (id, key) => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('input', () => {
                    ordersListState.filters[key] = el.value || '';
                    applyFiltersAndRender();
                });
            };

            bind('filter-vorgang', 'vorgang');
            bind('filter-customer', 'customer');
            bind('filter-entryDate', 'entryDate');
            bind('filter-subject', 'subject');
            bind('filter-serialNumber', 'serialNumber');

            document.querySelectorAll('#orders-container th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const k = th.getAttribute('data-key');
                    if (!k) return;
                    if (ordersListState.sortKey === k) {
                        ordersListState.sortDir = ordersListState.sortDir === 'asc' ? 'desc' : 'asc';
                    } else {
                        ordersListState.sortKey = k;
                        // Standardrichtung: Datum desc, sonst asc
                        ordersListState.sortDir = (k === 'entryDate') ? 'desc' : 'asc';
                    }
                    applyFiltersAndRender();
                });
            });

            updateSortIndicators();
        }

        function renderOrdersTable(orders) {
            const ordersBody = document.getElementById('orders-body');
            const emptyState = document.getElementById('empty-orders');

            if (!orders || orders.length === 0) {
                ordersBody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            ordersBody.innerHTML = '';

            orders.forEach(order => {
                const prog = getProgress(order);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight: bold; color: var(--primary-blue);">${order.vorgang}</td>
                    <td>${order.customer}</td>
                    <td>${order.entryDate ? new Date(order.entryDate).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric'}) : '-'}</td>
                    <td>${order.subject}</td>
                    <td>${order.serialNumber || ''}</td>
                    <td>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: ${prog.pct}%">${prog.pct}%</div>
                        </div>
                        <div class="progress-text">${prog.text}</div>
                    </td>
                    <td>
                        <div class="status-checkboxes">
                            <label class="status-checkbox-label"><input type="checkbox" ${order.status?.auftragErteilt ? 'checked' : ''} onchange="updateOrderStatus('${order.id}', 'auftragErteilt', this.checked)"> <span>Auftrag erteilt</span></label>
                            <label class="status-checkbox-label"><input type="checkbox" ${order.status?.reparaturAbgeschlossen ? 'checked' : ''} onchange="updateOrderStatus('${order.id}', 'reparaturAbgeschlossen', this.checked)"> <span>Abgeschlossen</span></label>
                            <label class="status-checkbox-label"><input type="checkbox" ${order.status?.versendetAnKunden ? 'checked' : ''} onchange="updateOrderStatus('${order.id}', 'versendetAnKunden', this.checked)"> <span>Versendet</span></label>
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            <button class="edit-btn" onclick="editOrder('${order.id}')">Laden</button>
                            <button class="delete-btn" onclick="deleteOrder('${order.id}')">X</button>
                        </div>
                    </td>
                `;
                ordersBody.appendChild(tr);
            });
        }

        window.updateOrderStatus = function(orderId, type, checked) {
            const idx = ordersDatabase.findIndex(o => String(o.id) === String(orderId));
            if (idx !== -1) {
                if(!ordersDatabase[idx].status) ordersDatabase[idx].status = {};
                ordersDatabase[idx].status[type] = checked;
                localStorage.setItem('ibgOrdersDatabase', JSON.stringify(ordersDatabase));
                syncOrderToCloud(ordersDatabase[idx]);
                loadOrdersList();
            }
        };
        
        // ============================================
        // ERWEITERTE editOrder() Funktion
        // ============================================
        window.editOrder = function(id) {
            const order = ordersDatabase.find(o => String(o.id) === String(id));
            if (!order) {
                alert("Auftrag nicht gefunden!");
                return;
            }
            
            // Basis-Formular befüllen
            document.getElementById('order-id').value = order.id;
            document.getElementById('vorgang').value = order.vorgang || '';
            document.getElementById('customer').value = order.customer || '';
            document.getElementById('entry-date').value = order.entryDate || '';
            document.getElementById('subject').value = order.subject || '';
            document.getElementById('serial-number').value = order.serialNumber || '';
            document.getElementById('name').value = order.name || '';
            document.getElementById('hours').value = order.hours || 0;
            document.getElementById('error-description').value = order.errorDescription || '';
            document.getElementById('work-todo').value = order.workTodo || '';
            
            // NEUE FELDER: Zubehör laden
            if (order.accessories) {
                document.getElementById('zubehoer-hintere-kamera').checked = order.accessories.hintereKamera || false;
                document.getElementById('zubehoer-drehkamera').checked = order.accessories.drehkamera || false;
                document.getElementById('zubehoer-steuerkoffer').checked = order.accessories.steuerkoffer || false;
                document.getElementById('zubehoer-sonstiges').value = order.accessories.sonstiges || '';
            }
            
            // NEUE FELDER: Funktionsprüfung laden
            if (order.functionTests) {
                document.getElementById('funktion-fahren').checked = order.functionTests.fahren || false;
                document.getElementById('funktion-heben').checked = order.functionTests.heben || false;
                document.getElementById('funktion-drehen').checked = order.functionTests.drehen || false;
                document.getElementById('funktion-fraeskopf-schwenken').checked = order.functionTests.fraeskopfSchwenken || false;
                document.getElementById('funktion-fraesen').checked = order.functionTests.fraesen || false;
                document.getElementById('funktion-spuelen').checked = order.functionTests.spuelen || false;
                document.getElementById('funktion-bild-hintere').checked = order.functionTests.bildHintere || false;
                document.getElementById('funktion-led-hintere').checked = order.functionTests.ledHintere || false;
                document.getElementById('funktion-bild-dreh').checked = order.functionTests.bildDreh || false;
                document.getElementById('funktion-led-dreh').checked = order.functionTests.ledDreh || false;
                document.getElementById('funktion-kamera-umschalten').checked = order.functionTests.kameraUmschalten || false;
            }
            
            

            // NEUE FELDER: Abnahmeprotokoll laden
            if (order.acceptanceProtocol) {
                document.getElementById('abnahme-dichtigkeit').checked = order.acceptanceProtocol.dichtigkeitstest || false;
                document.getElementById('abnahme-fahren').checked = order.acceptanceProtocol.fahrenGetestet || false;
                document.getElementById('abnahme-drehen').checked = order.acceptanceProtocol.drehenGetestet || false;
                document.getElementById('abnahme-heben').checked = order.acceptanceProtocol.hebenGetestet || false;
                document.getElementById('abnahme-fraesen-real').checked = order.acceptanceProtocol.fraesenReal || false;

                document.getElementById('abnahme-pruefdatum').value = order.acceptanceProtocol.pruefdatum || '';
                document.getElementById('abnahme-pruefer').value = order.acceptanceProtocol.pruefer || '';
                document.getElementById('abnahme-anmerkungen').value = order.acceptanceProtocol.anmerkungen || '';
            }
// Dynamische Checkboxen-Sichtbarkeit aktualisieren
            updateDynamicCheckboxes();
            
            // Checklisten generieren
            generateTaskCheckboxes();
            
            // Checkbox-Status wiederherstellen
            if (order.workTasks) {
                order.workTasks.forEach((t, i) => {
                    const cb = document.getElementById(`task-${i}`);
                    if (cb) {
                        cb.checked = t.completed;
                        if (t.completed) cb.closest('.task-checkbox-item').classList.add('completed');
                    }
                });
            }
            
            // Ersatzteile befüllen
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            if (order.parts && order.parts.length > 0) {
                order.parts.forEach(part => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td><input type="text" value="${part.articleNumber || ''}"></td>
                        <td><input type="text" value="${part.description || ''}"></td>
                        <td><input type="text" value="${part.quantity || ''}"></td>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>';
            }
            
            // Ansicht wechseln
            document.getElementById('orders-container').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
            window.scrollTo(0,0);
        };
        
        window.deleteOrder = function(id) {
            if (confirm('Auftrag lokal löschen?')) {
                ordersDatabase = ordersDatabase.filter(o => String(o.id) !== String(id));
                localStorage.setItem('ibgOrdersDatabase', JSON.stringify(ordersDatabase));
                loadOrdersList();
            }
        };
        
        function resetForm() {
            document.getElementById('order-id').value = '';
            document.getElementById('vorgang').value = '';
            document.getElementById('customer').value = '';
            document.getElementById('subject').value = '';
            document.getElementById('serial-number').value = '';
            document.getElementById('name').value = '';
            document.getElementById('hours').value = '';
            document.getElementById('error-description').value = '';
            document.getElementById('work-todo').value = '';
            document.getElementById('work-tasks-container').style.display = 'none';
            document.getElementById('table-body').innerHTML = '<tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>';
            
            // Neue Felder zurücksetzen
            document.getElementById('zubehoer-hintere-kamera').checked = false;
            document.getElementById('zubehoer-drehkamera').checked = false;
            document.getElementById('zubehoer-steuerkoffer').checked = false;
            document.getElementById('zubehoer-sonstiges').value = '';
            
            document.getElementById('funktion-fahren').checked = false;
            document.getElementById('funktion-heben').checked = false;
            document.getElementById('funktion-drehen').checked = false;
            document.getElementById('funktion-fraeskopf-schwenken').checked = false;
            document.getElementById('funktion-fraesen').checked = false;
            document.getElementById('funktion-spuelen').checked = false;
            document.getElementById('funktion-bild-hintere').checked = false;
            document.getElementById('funktion-led-hintere').checked = false;
            document.getElementById('funktion-bild-dreh').checked = false;
            document.getElementById('funktion-led-dreh').checked = false;
            document.getElementById('funktion-kamera-umschalten').checked = false;
            
            // Abnahmeprotokoll zurücksetzen
            document.getElementById('abnahme-dichtigkeit').checked = false;
            document.getElementById('abnahme-fahren').checked = false;
            document.getElementById('abnahme-drehen').checked = false;
            document.getElementById('abnahme-heben').checked = false;
            document.getElementById('abnahme-fraesen-real').checked = false;
            document.getElementById('abnahme-pruefdatum').value = '';
            document.getElementById('abnahme-pruefer').value = '';
            document.getElementById('abnahme-anmerkungen').value = '';
            
            updateDynamicCheckboxes();
        }
        
        async function generatePDF(orderData) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Helper-Funktion für Checkboxen
            const checkMark = (value) => value ? '☑' : '☐';
            
            // SEITE 1: Alle Informationen bis Arbeitsaufgaben
            const page1Content = `
                <div style="font-family: Arial, sans-serif; padding: 20px; font-size: 12px;">
                    <h1 style="color: #005293; font-size: 20px; margin-bottom: 10px;">IBG HYDROTECH - REPARATURPROTOKOLL</h1>
                    <hr style="border: 1px solid #e37222; margin-bottom: 15px;">
                    
                    <h2 style="color: #005293; font-size: 16px; margin-top: 15px; margin-bottom: 10px;">Auftragsstammdaten</h2>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                        <tr>
                            <td style="padding: 5px; width: 30%;"><strong>Vorgang:</strong></td>
                            <td style="padding: 5px;">${orderData.vorgang || '-'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px;"><strong>Kunde:</strong></td>
                            <td style="padding: 5px;">${orderData.customer || '-'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px;"><strong>Eingangsdatum:</strong></td>
                            <td style="padding: 5px;">${orderData.entryDate || '-'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px;"><strong>Betrifft:</strong></td>
                            <td style="padding: 5px;">${orderData.subject || '-'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px;"><strong>Seriennummer:</strong></td>
                            <td style="padding: 5px;">${orderData.serialNumber || '-'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px;"><strong>Bearbeiter:</strong></td>
                            <td style="padding: 5px;">${orderData.name || '-'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px;"><strong>Stunden:</strong></td>
                            <td style="padding: 5px;">${orderData.hours || 0}</td>
                        </tr>
                    </table>
                    
                    <h3 style="color: #005293; font-size: 14px; margin-top: 15px; margin-bottom: 8px;">Mitgeliefertes Zubehör</h3>
                    <p style="margin: 5px 0;">
                        ${checkMark(orderData.accessories?.hintereKamera)} Hintere Kamera &nbsp;&nbsp;
                        ${checkMark(orderData.accessories?.drehkamera)} Drehkamera &nbsp;&nbsp;
                        ${checkMark(orderData.accessories?.steuerkoffer)} Steuerkoffer
                    </p>
                    ${orderData.accessories?.sonstiges ? `<p style="margin: 5px 0;"><strong>Sonstiges:</strong> ${orderData.accessories.sonstiges}</p>` : ''}
                    
                    <h2 style="color: #005293; font-size: 16px; margin-top: 15px; margin-bottom: 10px;">Fehleranalyse</h2>
                    
                    <h3 style="color: #005293; font-size: 14px; margin-top: 10px; margin-bottom: 8px;">Funktionsüberprüfung bei Annahme</h3>
                    <p style="margin: 5px 0;">
                        ${checkMark(orderData.functionTests?.fahren)} Fahren &nbsp;&nbsp;
                        ${checkMark(orderData.functionTests?.heben)} Heben &nbsp;&nbsp;
                        ${checkMark(orderData.functionTests?.drehen)} Drehen &nbsp;&nbsp;
                        ${checkMark(orderData.functionTests?.fraeskopfSchwenken)} Fräskopf schwenken (HC200) &nbsp;&nbsp;
                        ${checkMark(orderData.functionTests?.fraesen)} Fräsen &nbsp;&nbsp;
                        ${checkMark(orderData.functionTests?.spuelen)} Spülen
                    </p>
                    
                    ${(orderData.functionTests?.bildHintere || orderData.functionTests?.ledHintere || 
                       orderData.functionTests?.bildDreh || orderData.functionTests?.ledDreh || 
                       orderData.functionTests?.kameraUmschalten) ? `
                    <p style="margin: 10px 0 5px 0;"><strong>Kamera-Funktionen:</strong></p>
                    <p style="margin: 5px 0;">
                        ${checkMark(orderData.functionTests?.bildHintere)} Bild hintere Kamera &nbsp;&nbsp;
                        ${checkMark(orderData.functionTests?.ledHintere)} LED hintere Kamera &nbsp;&nbsp;
                        ${checkMark(orderData.functionTests?.bildDreh)} Bild Drehkamera &nbsp;&nbsp;
                        ${checkMark(orderData.functionTests?.ledDreh)} LED Drehkamera &nbsp;&nbsp;
                        ${checkMark(orderData.functionTests?.kameraUmschalten)} Kamerabild umschalten
                    </p>` : ''}
                    
                    <h3 style="color: #005293; font-size: 14px; margin-top: 15px; margin-bottom: 8px;">Fehlerbeschreibung</h3>
                    <p style="border: 1px solid #e0e0e0; padding: 10px; background: #f5f5f5; margin-bottom: 15px;">${orderData.errorDescription || '-'}</p>
                    
                    <h2 style="color: #005293; font-size: 16px; margin-top: 15px; margin-bottom: 10px;">Arbeitsaufgaben</h2>
                    <p style="border: 1px solid #e0e0e0; padding: 10px; background: #f5f5f5; white-space: pre-wrap;">${orderData.workTodo || '-'}</p>
                    
                    ${orderData.workTasks && orderData.workTasks.length > 0 ? `
                    <h3 style="color: #005293; font-size: 14px; margin-top: 10px; margin-bottom: 8px;">Aufgaben-Checkliste</h3>
                    <ul style="margin-left: 20px;">
                        ${orderData.workTasks.map(task => `
                            <li style="margin: 3px 0;">${checkMark(task.completed)} ${task.task}</li>
                        `).join('')}
                    </ul>` : ''}
                </div>
            `;
            
            // Rendern der ersten Seite
            const temp1 = document.createElement('div');
            temp1.innerHTML = page1Content;
            temp1.style.width = '210mm';
            document.body.appendChild(temp1);
            const canvas1 = await html2canvas(temp1, { scale: 2 });
            document.body.removeChild(temp1);
            
            const imgData1 = canvas1.toDataURL('image/png');
            const imgWidth = 190;
            const imgHeight = (canvas1.height * imgWidth) / canvas1.width;
            doc.addImage(imgData1, 'PNG', 10, 10, imgWidth, imgHeight);
            
            // SEITE 2: Ersatzteile / Abnahmeprotokoll (mit Seitenumbruch)
            const ap = orderData.acceptanceProtocol || {};
            const hasAp = Object.values(ap).some(v => v === true);
            if ((orderData.parts && orderData.parts.length > 0) || hasAp) {
                doc.addPage();
                
                const page2Content = `
                    <div style="font-family: Arial, sans-serif; padding: 20px; font-size: 12px;">
                        <h1 style="color: #005293; font-size: 20px; margin-bottom: 10px;">IBG HYDROTECH - REPARATURPROTOKOLL</h1>
                        <p style="margin-bottom: 15px;"><strong>Vorgang:</strong> ${orderData.vorgang || '-'}</p>
                        <hr style="border: 1px solid #e37222; margin-bottom: 15px;">
                        
                        <h2 style="color: #005293; font-size: 16px; margin-bottom: 10px;">Benötigte Ersatzteile</h2>
                        ${orderData.parts && orderData.parts.length > 0 ? `
                        <table style="width: 100%; border-collapse: collapse; border: 1px solid #e0e0e0;">
                            <thead>
                                <tr style="background: linear-gradient(to right, #005293, #007bc0); color: white;">
                                    <th style="padding: 10px; text-align: left; border: 1px solid #e0e0e0;">Artikelnummer</th>
                                    <th style="padding: 10px; text-align: left; border: 1px solid #e0e0e0;">Beschreibung</th>
                                    <th style="padding: 10px; text-align: left; border: 1px solid #e0e0e0;">Menge</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${orderData.parts.map((part, index) => `
                                    <tr style="background: ${index % 2 === 0 ? '#ffffff' : '#f5f5f5'};">
                                        <td style="padding: 8px; border: 1px solid #e0e0e0;">${part.articleNumber || '-'}</td>
                                        <td style="padding: 8px; border: 1px solid #e0e0e0;">${part.description || '-'}</td>
                                        <td style="padding: 8px; border: 1px solid #e0e0e0;">${part.quantity || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>` : `<p style="margin: 5px 0; color: #666;">Keine Ersatzteile erfasst.</p>`}

                        <h2 style="color: #005293; font-size: 16px; margin-top: 18px; margin-bottom: 10px;">Abnahmeprotokoll vor Auslieferung</h2>
                        <p style="margin: 5px 0;">
                            ${checkMark(ap.dichtigkeitstest)} Dichtigkeitstest im Wasserbad durchgeführt<br>
                            ${checkMark(ap.fahrenGetestet)} Fahren getestet<br>
                            ${checkMark(ap.drehenGetestet)} Drehen getestet<br>
                            ${checkMark(ap.hebenGetestet)} Heben getestet<br>
                            ${checkMark(ap.fraesenReal)} Unter realen Bedingungen gefräst
                        </p>
                    </div>
                `;
                
                const temp2 = document.createElement('div');
                temp2.innerHTML = page2Content;
                temp2.style.width = '210mm';
                document.body.appendChild(temp2);
                const canvas2 = await html2canvas(temp2, { scale: 2 });
                document.body.removeChild(temp2);
                
                const imgData2 = canvas2.toDataURL('image/png');
                const imgHeight2 = (canvas2.height * imgWidth) / canvas2.width;
                doc.addImage(imgData2, 'PNG', 10, 10, imgWidth, imgHeight2);
            }
            
            doc.save(`Reparatur_${orderData.vorgang}.pdf`);
        }
        
        // Cloud-Sync Platzhalter - wird durch Google Apps Script verbunden
        function syncOrderToCloud(orderData) {
            if (!CLOUD_ENABLED || !GOOGLE_SCRIPT_URL) return;

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(orderData)
            })
            .then(r => r.json().catch(() => ({})))
            .then(resp => {
                if (resp && resp.result === 'success' && resp.id) {
                    // Falls Script eine ID zurückgibt, übernehmen (z.B. bei neuen Datensätzen)
                    const oldId = String(orderData.id);
                    const newId = String(resp.id);
                    if (newId && oldId !== newId) {
                        orderData.id = newId;
                        const idx = ordersDatabase.findIndex(o => String(o.id) === oldId);
                        if (idx !== -1) ordersDatabase[idx] = orderData;
                        localStorage.setItem('ibgOrdersDatabase', JSON.stringify(ordersDatabase));
                    }
                } else if (resp && resp.result === 'error') {
                    console.warn('Cloud-Sync Fehler:', resp.message || resp);
                }
            })
            .catch(err => console.warn('Cloud-Sync fehlgeschlagen:', err));
        }
        
        // Beim Laden der Seite
        window.addEventListener('DOMContentLoaded', () => {
            initOrdersListControls();
            loadOrdersList();
            // Setze heutiges Datum als Standard
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('entry-date').value = today;
        });
    </script>
</body>
</html>
