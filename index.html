<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reparaturauftrag - IBG HydroTech</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-blue: #005293;
            --secondary-blue: #007bc0;
            --accent-orange: #e37222;
            --light-gray: #f5f5f5;
            --medium-gray: #e0e0e0;
            --dark-gray: #333;
            --text-gray: #666;
            --white: #ffffff;
            --success-green: #28a745;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f0f2f5 0%, #e6e9f0 100%);
            color: var(--dark-gray);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(to right, var(--primary-blue), var(--secondary-blue));
            color: var(--white);
            padding: 2rem;
            text-align: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }
        
        .logo-icon {
            font-size: 2.5rem;
            margin-right: 15px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .content {
            padding: 2rem;
        }
        
        .section {
            margin-bottom: 2.5rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--medium-gray);
        }
        
        .section:last-child {
            border-bottom: none;
        }
        
        .section-title {
            color: var(--primary-blue);
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent-orange);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: var(--accent-orange);
        }
        
        /* STYLE FÜR DYNAMISCHE CHECKBOXEN (initial versteckt) */
        .dynamic-checkboxes {
            display: none;
        }
        
        .dynamic-checkboxes.visible {
            display: block;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1rem;
        }
        
        
        /* Abnahmeprotokoll: Prüfinfo-Zeile (2 breite Felder + Anmerkungen bis rechts) */
        .form-grid.abnahme-grid {
            grid-template-columns: 1fr 1fr 2fr;
        }
        .abnahme-grid .span-2 {
            grid-column: span 2;
        }
.form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        label {
            font-weight: bold;
            color: var(--primary-blue);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        label i {
            color: var(--accent-orange);
        }
        
        input[type="text"],
        input[type="date"],
        input[type="number"],
        input[type="checkbox"],
        textarea {
            padding: 1rem 1.2rem;
            border: 2px solid var(--medium-gray);
            border-radius: 8px;
            font-size: 1.1rem;
            transition: all 0.3s;
            background: var(--white);
            width: 100%;
        }
        
        input[type="checkbox"] {
            width: auto;
            padding: 0;
            margin-right: 0.5rem;
        }
        
        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--secondary-blue);
            box-shadow: 0 0 0 3px rgba(0, 114, 192, 0.2);
            transform: translateY(-2px);
        }
        
        textarea {
            min-height: 150px;
            resize: vertical;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            margin: 1rem 0;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.8rem 1.2rem;
            background: var(--light-gray);
            border-radius: 8px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .checkbox-item:hover {
            background: var(--medium-gray);
            transform: translateY(-2px);
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 1.5rem;
            height: 1.5rem;
            cursor: pointer;
        }
        
        .checkbox-item label {
            font-weight: 500;
            cursor: pointer;
            margin: 0;
            font-size: 1rem;
        }
        
        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }
        
        button {
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: var(--white);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--secondary-blue), var(--primary-blue));
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--accent-orange), #ff8c42);
            color: var(--white);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #ff8c42, var(--accent-orange));
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-green), #34c759);
            color: var(--white);
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #34c759, var(--success-green));
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        thead {
            background: linear-gradient(to right, var(--primary-blue), var(--secondary-blue));
            color: var(--white);
        }
        
        th, td {
            padding: 1rem;
            text-align: left;
        }
        
        th {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        tbody tr {
            border-bottom: 1px solid var(--medium-gray);
            transition: background 0.3s;
        }
        
        tbody tr:hover {
            background: var(--light-gray);
        }
        
        tbody tr:last-child {
            border-bottom: none;
        }
        
        td input {
            padding: 0.8rem;
            margin: 0;
        }
        
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .button-group {
                display: none;
            }
            
            .container {
                box-shadow: none;
            }
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .section-title {
                font-size: 1.5rem;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
                justify-content: center;
            }
        }
        
        .task-checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.8rem 1.2rem;
            background: var(--light-gray);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.3s;
        }
        
        .task-checkbox-item.completed {
            background: #d4edda;
            text-decoration: line-through;
            color: var(--text-gray);
        }
        
        .task-checkbox-item input[type="checkbox"] {
            width: 1.5rem;
            height: 1.5rem;
            cursor: pointer;
        }
        
        #orders-container {
            display: none;
            padding: 2rem;
            background: var(--white);
            border-radius: 12px;
        }
        
        .orders-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .orders-header h2 {
            color: var(--primary-blue);
            font-size: 2rem;
        }
        
        .filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }
        
        .filter-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary-blue);
        }
        
        .filter-group input {
            padding: 0.6rem;
            font-size: 0.95rem;
        }
        
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .orders-table thead {
            background: linear-gradient(to right, var(--primary-blue), var(--secondary-blue));
            color: var(--white);
        }
        
        .orders-table th {
            padding: 1rem;
            text-align: left;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        .orders-table th.sortable:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .sort-indicator {
            margin-left: 0.5rem;
            font-size: 0.8rem;
        }
        
        .orders-table td {
            padding: 0.8rem 1rem;
            border-bottom: 1px solid var(--medium-gray);
        }
        
        .orders-table tbody tr:hover {
            background: var(--light-gray);
        }
        
        .progress-bar-container {
            background: var(--medium-gray);
            border-radius: 10px;
            overflow: hidden;
            height: 24px;
            position: relative;
        }
        
        .progress-bar-fill {
            background: linear-gradient(to right, var(--success-green), #34c759);
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.85rem;
            transition: width 0.3s;
        }
        
        .progress-text {
            font-size: 0.85rem;
            color: var(--text-gray);
            margin-top: 0.3rem;
        }
        
        .status-checkboxes {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }
        
        .status-checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        .status-checkbox-label input {
            cursor: pointer;
        }
        
        .edit-btn, .delete-btn {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            border-radius: 5px;
            cursor: pointer;
            border: none;
            font-weight: bold;
        }
        
        .edit-btn {
            background: var(--secondary-blue);
            color: white;
        }
        
        .edit-btn:hover {
            background: var(--primary-blue);
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
        }
        
        .delete-btn:hover {
            background: #c82333;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-gray);
        }
        
        .empty-state i {
            font-size: 4rem;
            color: var(--medium-gray);
            margin-bottom: 1rem;
        }
        
        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-spinner {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid var(--light-gray);
            border-top: 4px solid var(--primary-blue);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid #f5c6cb;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Daten werden geladen...</p>
        </div>
    </div>

    <div class="container" id="main-container">
        <header>
            <div class="logo">
                <i class="fas fa-tools logo-icon"></i>
                <div>
                    <h1>IBG HydroTech</h1>
                    <div class="subtitle">Reparaturauftrag - Fräsroboter-Service</div>
                </div>
            </div>
        </header>
        
        <div class="content">
            <!-- Verstecktes ID-Feld -->
            <input type="hidden" id="order-id">
            
            <!-- Sektion 1: Auftragsstammdaten -->
            <div class="section">
                <h2 class="section-title">
                    <i class="fas fa-clipboard-list"></i>
                    Auftragsstammdaten
                </h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label><i class="fas fa-hashtag"></i> Vorgang *</label>
                        <input type="text" id="vorgang" placeholder="z.B. 2024-001" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Kunde *</label>
                        <input type="text" id="customer" placeholder="Kundenname" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-calendar-alt"></i> Eingangsdatum</label>
                        <input type="date" id="entry-date">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-tag"></i> Betrifft *</label>
                        <input type="text" id="subject" placeholder="z.B. Fräsroboter HC200" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-barcode"></i> Seriennummer</label>
                        <input type="text" id="serial-number" placeholder="Seriennummer">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-user-tie"></i> Bearbeiter *</label>
                        <input type="text" id="name" placeholder="Name des Bearbeiters" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-clock"></i> Stunden</label>
                        <input type="number" id="hours" placeholder="Arbeitsstunden" min="0" step="0.5" value="0">
                    </div>
                </div>
            </div>
            
            <!-- NEUE SEKTION: Zubehör -->
            <div class="section">
                <h2 class="section-title">
                    <i class="fas fa-box"></i>
                    Mitgeliefertes Zubehör
                </h2>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="zubehoer-hintere-kamera">
                        <label for="zubehoer-hintere-kamera">Hintere Kamera</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="zubehoer-drehkamera">
                        <label for="zubehoer-drehkamera">Drehkamera</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="zubehoer-steuerkoffer">
                        <label for="zubehoer-steuerkoffer">Steuerkoffer</label>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 1rem;">
                    <label><i class="fas fa-list"></i> Sonstiges Zubehör</label>
                    <input type="text" id="zubehoer-sonstiges" placeholder="Weitere mitgelieferte Teile...">
                </div>
            </div>
            
            <!-- Sektion 2: Fehleranalyse -->
            <div class="section">
                <h2 class="section-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    Fehleranalyse
                </h2>
                
                <!-- NEUE SUB-SEKTION: Funktionsüberprüfung bei Annahme -->
                <h3 style="color: var(--primary-blue); margin-bottom: 1rem; font-size: 1.3rem;">
                    <i class="fas fa-check-circle" style="color: var(--accent-orange);"></i>
                    Funktionsüberprüfung bei Annahme
                </h3>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="funktion-fahren">
                        <label for="funktion-fahren">Fahren</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="funktion-heben">
                        <label for="funktion-heben">Heben</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="funktion-drehen">
                        <label for="funktion-drehen">Drehen</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="funktion-fraeskopf-schwenken">
                        <label for="funktion-fraeskopf-schwenken">Fräskopf schwenken (HC200)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="funktion-fraesen">
                        <label for="funktion-fraesen">Fräsen</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="funktion-spuelen">
                        <label for="funktion-spuelen">Spülen</label>
                    </div>
                </div>
                
                <!-- Kamera-Funktionen (dynamisch anzeigen, wenn mind. eine der Checkboxen aktiviert ist) -->
                <div id="kamera-funktionen-container" class="dynamic-checkboxes">
                    <h4 style="color: var(--primary-blue); margin: 1.5rem 0 1rem 0; font-size: 1.1rem;">
                        Kamera-Funktionen
                    </h4>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="funktion-bild-hintere">
                            <label for="funktion-bild-hintere">Bild hintere Kamera</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="funktion-led-hintere">
                            <label for="funktion-led-hintere">LED hintere Kamera</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="funktion-bild-dreh">
                            <label for="funktion-bild-dreh">Bild Drehkamera</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="funktion-led-dreh">
                            <label for="funktion-led-dreh">LED Drehkamera</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="funktion-kamera-umschalten">
                            <label for="funktion-kamera-umschalten">Kamerabild umschalten</label>
                        </div>
                    </div>
                </div>
                
                <h3 style="color: var(--primary-blue); margin: 2rem 0 1rem 0; font-size: 1.3rem;">
                    <i class="fas fa-file-alt" style="color: var(--accent-orange);"></i>
                    Fehlerbeschreibung
                </h3>
                <div class="form-group">
                    <textarea id="error-description" placeholder="Beschreiben Sie den Fehler oder das Problem detailliert..."></textarea>
                </div>
            </div>
            
            <!-- Sektion 3: Arbeitsaufträge -->
            <div class="section">
                <h2 class="section-title">
                    <i class="fas fa-tasks"></i>
                    Arbeitsaufträge
                </h2>
                <div class="form-group">
                    <label><i class="fas fa-wrench"></i> Durchzuführende Arbeiten</label>
                    <textarea id="work-todo" placeholder="Jede Zeile wird zu einer eigenen Aufgabe..." oninput="updateDynamicCheckboxes()"></textarea>
                </div>
                
                <!-- Dynamisch generierte Checkboxen -->
                <div id="work-tasks-container" class="dynamic-checkboxes">
                    <h3 style="color: var(--primary-blue); margin-top: 1.5rem; margin-bottom: 1rem; font-size: 1.2rem;">
                        Aufgaben-Checkliste
                    </h3>
                    <div id="work-tasks-list"></div>
                </div>
            </div>
            
            <!-- Sektion 4: Ersatzteile -->
            <div class="section">
                <h2 class="section-title">
                    <i class="fas fa-cogs"></i>
                    Benötigte Ersatzteile
                </h2>
                <table>
                    <thead>
                        <tr>
                            <th>Artikelnummer</th>
                            <th>Beschreibung</th>
                            <th>Menge</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr>
                            <td><input type="text" placeholder="Artikelnummer"></td>
                            <td><input type="text" placeholder="Beschreibung"></td>
                            <td><input type="text" placeholder="Menge"></td>
                        </tr>
                    </tbody>
                </table>
                <button class="btn-secondary" onclick="addRow()">
                    <i class="fas fa-plus"></i> Weitere Zeile hinzufügen
                </button>
            </div>
            
            <!-- NEUE SEKTION: Abnahmeprotokoll vor Auslieferung -->
            <div class="section">
                <h2 class="section-title">
                    <i class="fas fa-clipboard-check"></i>
                    Abnahmeprotokoll vor Auslieferung
                </h2>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="abnahme-dichtigkeit">
                        <label for="abnahme-dichtigkeit">Dichtigkeitstest im Wasserbad durchgeführt</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="abnahme-fahren">
                        <label for="abnahme-fahren">Fahren getestet</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="abnahme-drehen">
                        <label for="abnahme-drehen">Drehen getestet</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="abnahme-heben">
                        <label for="abnahme-heben">Heben getestet</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="abnahme-fraesen-real">
                        <label for="abnahme-fraesen-real">Unter realen Bedingungen gefräst</label>
                    </div>
                </div>

                <!-- Neue Textfelder: Prüfdatum, Prüfer, Anmerkungen -->
                <div class="form-grid abnahme-grid" style="margin-top: 1.5rem;">
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> Prüfdatum</label>
                        <input type="date" id="abnahme-pruefdatum">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-user-check"></i> Prüfer</label>
                        <input type="text" id="abnahme-pruefer" placeholder="Name des Prüfers">
                    </div>
                    <div class="form-group span-2">
                        <label><i class="fas fa-comment"></i> Anmerkungen</label>
                        <input type="text" id="abnahme-anmerkungen" placeholder="Weitere Anmerkungen zur Abnahme...">
                    </div>
                </div>
            </div>
            
            <!-- Buttons -->
            <div class="button-group">
                <button class="btn-primary" onclick="saveOrder()" id="save-btn">
                    <i class="fas fa-save"></i> Speichern
                </button>
                <button class="btn-secondary" onclick="saveAndGeneratePDF()" id="save-pdf-btn">
                    <i class="fas fa-file-pdf"></i> Speichern & PDF erstellen
                </button>
                <button class="btn-success" onclick="showOrdersList()">
                    <i class="fas fa-list"></i> Aufträge anzeigen
                </button>
            </div>
        </div>
    </div>
    
    <!-- AUFTRÄGE-ÜBERSICHT (initial versteckt) -->
    <div id="orders-container">
        <div class="orders-header">
            <h2><i class="fas fa-list-ul"></i> Aufträge-Übersicht</h2>
            <button class="btn-primary" onclick="backToForm()">
                <i class="fas fa-arrow-left"></i> Zurück zum Formular
            </button>
        </div>
        
        <!-- Filter-Zeile -->
        <div class="filters-row">
            <div class="filter-group">
                <label>Vorgang</label>
                <input type="text" id="filter-vorgang" placeholder="Filtern...">
            </div>
            <div class="filter-group">
                <label>Kunde</label>
                <input type="text" id="filter-customer" placeholder="Filtern...">
            </div>
            <div class="filter-group">
                <label>Eingangsdatum</label>
                <input type="date" id="filter-entryDate">
            </div>
            <div class="filter-group">
                <label>Betrifft</label>
                <input type="text" id="filter-subject" placeholder="Filtern...">
            </div>
            <div class="filter-group">
                <label>Seriennummer</label>
                <input type="text" id="filter-serialNumber" placeholder="Filtern...">
            </div>
        </div>
        
        <table class="orders-table">
            <thead>
                <tr>
                    <th class="sortable" data-key="vorgang">Vorgang <span class="sort-indicator"></span></th>
                    <th class="sortable" data-key="customer">Kunde <span class="sort-indicator"></span></th>
                    <th class="sortable" data-key="entryDate">Eingangsdatum <span class="sort-indicator"></span></th>
                    <th class="sortable" data-key="subject">Betrifft <span class="sort-indicator"></span></th>
                    <th class="sortable" data-key="serialNumber">Seriennummer <span class="sort-indicator"></span></th>
                    <th>Fortschritt</th>
                    <th>Status</th>
                    <th>Aktionen</th>
                </tr>
            </thead>
            <tbody id="orders-body">
            </tbody>
        </table>
        
        <div id="empty-orders" class="empty-state" style="display: none;">
            <i class="fas fa-inbox"></i>
            <p>Keine Aufträge vorhanden</p>
        </div>
    </div>

    <script>
        // ============================================
        // KONFIGURATION FÜR GOOGLE SHEETS SYNC
        // ============================================
        // WICHTIG: Hier Ihre Google Apps Script URL eintragen!
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzGBS0zcRjGYKMjkZxQ0WB50iPrcH3360ln4YZdpmL3jSn7ZeFq4VQKRkLa2WSgoQKE/exec';  // z.B. https://script.google.com/macros/s/...../exec
        
        // Datenbank-Array (Cache für lokale Anzeige)
        let ordersDatabase = [];

        // Filter/Sort-State für Aufträge-Liste
        let ordersListState = {
            filters: {},
            sortKey: 'entryDate',
            sortDir: 'desc'
        };

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        
        function showLoading() {
            document.getElementById('loading-overlay').classList.add('active');
        }
        
        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('active');
        }
        
        function showError(message) {
            alert('Fehler: ' + message);
        }
        
        function showSuccess(message) {
            // Optionaler Success-Toast oder Alert
            console.log('Erfolg:', message);
        }

        function addRow() {
            const tbody = document.getElementById('table-body');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><input type="text" placeholder="Artikelnummer"></td>
                <td><input type="text" placeholder="Beschreibung"></td>
                <td><input type="text" placeholder="Menge"></td>
            `;
        }
        
        function updateDynamicCheckboxes() {
            const workTodoText = document.getElementById('work-todo').value.trim();
            const tasks = workTodoText.split('\n').filter(t => t.trim());
            const container = document.getElementById('work-tasks-container');
            const list = document.getElementById('work-tasks-list');
            
            if (tasks.length > 0) {
                container.classList.add('visible');
                list.innerHTML = '';
                tasks.forEach((task, index) => {
                    const div = document.createElement('div');
                    div.className = 'task-checkbox-item';
                    div.innerHTML = `
                        <input type="checkbox" id="task-${index}" onchange="toggleTaskComplete(this)">
                        <label for="task-${index}">${task}</label>
                    `;
                    list.appendChild(div);
                });
            } else {
                container.classList.remove('visible');
            }
            
            // Kamera-Funktionen zeigen/verstecken
            const kameraContainer = document.getElementById('kamera-funktionen-container');
            const hasZubehoer = document.getElementById('zubehoer-hintere-kamera').checked || 
                               document.getElementById('zubehoer-drehkamera').checked;
            if (hasZubehoer) {
                kameraContainer.classList.add('visible');
            } else {
                kameraContainer.classList.remove('visible');
            }
        }
        
        // Event-Listener für Zubehör-Checkboxen
        document.getElementById('zubehoer-hintere-kamera').addEventListener('change', updateDynamicCheckboxes);
        document.getElementById('zubehoer-drehkamera').addEventListener('change', updateDynamicCheckboxes);
        
        function toggleTaskComplete(checkbox) {
            const parent = checkbox.closest('.task-checkbox-item');
            if (checkbox.checked) {
                parent.classList.add('completed');
            } else {
                parent.classList.remove('completed');
            }
        }
        
        // ============================================
        // HAUPTFUNKTIONEN: SPEICHERN & LADEN
        // ============================================
        
        async function saveOrder() {
            const data = collectFormData();
            if (!validateOrderData(data)) return;
            
            await saveOrderToGoogleSheets(data);
        }
        
        async function saveAndGeneratePDF() {
            const data = collectFormData();
            if (!validateOrderData(data)) return;
            
            await saveOrderToGoogleSheets(data);
            generatePDF(data);
        }
        
        async function showOrdersList() {
            // Erst Daten laden
            await loadOrdersList();
            
            // Dann Ansicht wechseln (NACH dem Laden)
            document.getElementById('main-container').style.display = 'none';
            document.getElementById('orders-container').style.display = 'block';
        }
        
        function backToForm() {
            document.getElementById('orders-container').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
        }
        
        // ============================================
        // DATEN SAMMELN UND VALIDIEREN
        // ============================================
        
        function collectFormData() {
            // BUGFIX: ID muss VOR der data-Definition extrahiert werden!
            const orderId = document.getElementById('order-id').value || `order-${Date.now()}`;
            
            const workTodoText = document.getElementById('work-todo').value.trim();
            const tasks = workTodoText.split('\n').filter(t => t.trim());
            const workTasks = tasks.map((task, i) => ({
                task: task,
                completed: document.getElementById(`task-${i}`)?.checked || false
            }));
            
            const data = {
                id: orderId,
                vorgang: document.getElementById('vorgang').value,
                customer: document.getElementById('customer').value,
                entryDate: document.getElementById('entry-date').value,
                subject: document.getElementById('subject').value,
                serialNumber: document.getElementById('serial-number').value,
                name: document.getElementById('name').value,
                hours: parseFloat(document.getElementById('hours').value) || 0,
                errorDescription: document.getElementById('error-description').value,
                workTodo: workTodoText,
                workTasks: workTasks,
                parts: [],
                
                accessories: {
                    hintereKamera: document.getElementById('zubehoer-hintere-kamera').checked,
                    drehkamera: document.getElementById('zubehoer-drehkamera').checked,
                    steuerkoffer: document.getElementById('zubehoer-steuerkoffer').checked,
                    sonstiges: document.getElementById('zubehoer-sonstiges').value
                },
                
                functionTests: {
                    fahren: document.getElementById('funktion-fahren').checked,
                    heben: document.getElementById('funktion-heben').checked,
                    drehen: document.getElementById('funktion-drehen').checked,
                    fraeskopfSchwenken: document.getElementById('funktion-fraeskopf-schwenken').checked,
                    fraesen: document.getElementById('funktion-fraesen').checked,
                    spuelen: document.getElementById('funktion-spuelen').checked,
                    bildHintere: document.getElementById('funktion-bild-hintere').checked,
                    ledHintere: document.getElementById('funktion-led-hintere').checked,
                    bildDreh: document.getElementById('funktion-bild-dreh').checked,
                    ledDreh: document.getElementById('funktion-led-dreh').checked,
                    kameraUmschalten: document.getElementById('funktion-kamera-umschalten').checked
                },

                acceptanceProtocol: {
                    dichtigkeitstest: document.getElementById('abnahme-dichtigkeit').checked,
                    fahrenGetestet: document.getElementById('abnahme-fahren').checked,
                    drehenGetestet: document.getElementById('abnahme-drehen').checked,
                    hebenGetestet: document.getElementById('abnahme-heben').checked,
                    fraesenReal: document.getElementById('abnahme-fraesen-real').checked,
                    pruefdatum: document.getElementById('abnahme-pruefdatum').value || '',
                    pruefer: document.getElementById('abnahme-pruefer').value || '',
                    anmerkungen: document.getElementById('abnahme-anmerkungen').value || ''
                },

                // Status aus bestehendem Datensatz übernehmen (falls vorhanden)
                status: ordersDatabase.find(o => String(o.id) === String(orderId))?.status || {}
            };
            
            document.querySelectorAll('#table-body tr').forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0].value.trim() || inputs[1].value.trim() || inputs[2].value.trim()) {
                    data.parts.push({
                        articleNumber: inputs[0].value.trim(),
                        description: inputs[1].value.trim(),
                        quantity: inputs[2].value.trim()
                    });
                }
            });
            
            return data;
        }
        
        function validateOrderData(data) {
            if (!data.vorgang || !data.customer || !data.subject || !data.name) {
                alert('Bitte alle Pflichtfelder (Vorgang, Kunde, Betrifft, Name) ausfüllen!');
                return false;
            }
            return true;
        }
        
        // ============================================
        // GOOGLE SHEETS INTEGRATION
        // ============================================
        
        async function saveOrderToGoogleSheets(data) {
            if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === 'HIER_IHRE_GOOGLE_SCRIPT_URL') {
                alert('FEHLER: Google Script URL ist nicht konfiguriert!\n\nBitte tragen Sie Ihre Google Apps Script URL in der Datei ein (Zeile 628).');
                return;
            }
            
            showLoading();
            document.getElementById('save-btn').disabled = true;
            document.getElementById('save-pdf-btn').disabled = true;
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result && result.result === 'success') {
                    // Erfolg!
                    if (result.id && result.id !== data.id) {
                        // Server hat neue ID vergeben
                        data.id = result.id;
                        document.getElementById('order-id').value = result.id;
                    }
                    
                    // Lokale Datenbank aktualisieren
                    const idx = ordersDatabase.findIndex(o => String(o.id) === String(data.id));
                    if (idx !== -1) {
                        ordersDatabase[idx] = data;
                    } else {
                        ordersDatabase.push(data);
                    }
                    
                    alert('✓ Auftrag erfolgreich in Google Sheets gespeichert!');
                    resetForm();
                } else {
                    throw new Error(result.message || 'Unbekannter Fehler beim Speichern');
                }
            } catch (error) {
                console.error('Fehler beim Speichern:', error);
                showError('Konnte nicht zu Google Sheets speichern: ' + error.message);
            } finally {
                hideLoading();
                document.getElementById('save-btn').disabled = false;
                document.getElementById('save-pdf-btn').disabled = false;
            }
        }
        
        async function loadOrdersList() {
            if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === 'HIER_IHRE_GOOGLE_SCRIPT_URL') {
                alert('FEHLER: Google Script URL ist nicht konfiguriert!\n\nBitte tragen Sie Ihre Google Apps Script URL in der Datei ein.');
                ordersDatabase = [];
                applyFiltersAndRender();
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, { 
                    method: 'GET',
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    throw new Error('Netzwerkfehler: ' + response.status);
                }
                
                const data = await response.json();
                
                if (Array.isArray(data)) {
                    ordersDatabase = data;
                    applyFiltersAndRender();
                } else {
                    throw new Error('Ungültiges Datenformat von Google Sheets erhalten');
                }
            } catch (error) {
                console.error('Fehler beim Laden:', error);
                showError('Konnte Daten nicht von Google Sheets laden: ' + error.message);
                ordersDatabase = [];
                applyFiltersAndRender();
            } finally {
                hideLoading();
            }
        }

        function getProgress(order) {
            // Fortschritt basiert auf erledigten Arbeitsaufgaben (workTasks)
            const tasks = order.workTasks || [];
            const total = tasks.length;
            
            if (total === 0) {
                // Keine Aufgaben definiert
                return { pct: 0, text: 'Keine Aufgaben definiert' };
            }
            
            const completed = tasks.filter(task => task.completed).length;
            const pct = Math.round((completed / total) * 100);

            let text = '';
            if (completed === 0) {
                text = `0 von ${total} Aufgaben erledigt`;
            } else if (completed === total) {
                text = `Alle ${total} Aufgaben erledigt ✓`;
            } else {
                text = `${completed} von ${total} Aufgaben erledigt`;
            }

            return { pct, text };
        }

        function applyFiltersAndSort(orders) {
            let filtered = [...orders];
            const flt = ordersListState.filters;

            if (flt.vorgang) {
                const term = flt.vorgang.toLowerCase();
                filtered = filtered.filter(o => (o.vorgang || '').toLowerCase().includes(term));
            }
            if (flt.customer) {
                const term = flt.customer.toLowerCase();
                filtered = filtered.filter(o => (o.customer || '').toLowerCase().includes(term));
            }
            if (flt.entryDate) {
                filtered = filtered.filter(o => o.entryDate === flt.entryDate);
            }
            if (flt.subject) {
                const term = flt.subject.toLowerCase();
                filtered = filtered.filter(o => (o.subject || '').toLowerCase().includes(term));
            }
            if (flt.serialNumber) {
                const term = flt.serialNumber.toLowerCase();
                filtered = filtered.filter(o => (o.serialNumber || '').toLowerCase().includes(term));
            }

            const sorted = filtered.sort((a, b) => {
                const key = ordersListState.sortKey;
                const dir = ordersListState.sortDir === 'asc' ? 1 : -1;
                let va = String(a[key] || '');
                let vb = String(b[key] || '');
                const na = Number(va.replace(',', '.'));
                const nb = Number(vb.replace(',', '.'));
                if (!Number.isNaN(na) && !Number.isNaN(nb) && (va.trim() !== '' || vb.trim() !== '')) {
                    return (na - nb) * dir;
                }
                return va.localeCompare(vb, 'de', { sensitivity: 'base' }) * dir;
            });

            return sorted;
        }

        function updateSortIndicators() {
            document.querySelectorAll('#orders-container th.sortable').forEach(th => {
                const span = th.querySelector('.sort-indicator');
                if (!span) return;
                const k = th.getAttribute('data-key');
                if (k === ordersListState.sortKey) {
                    span.textContent = ordersListState.sortDir === 'asc' ? '▲' : '▼';
                } else {
                    span.textContent = '';
                }
            });
        }

        function applyFiltersAndRender() {
            const viewOrders = applyFiltersAndSort(ordersDatabase);
            updateSortIndicators();
            renderOrdersTable(viewOrders);
        }

        function initOrdersListControls() {
            const bind = (id, key) => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('input', () => {
                    ordersListState.filters[key] = el.value || '';
                    applyFiltersAndRender();
                });
            };

            bind('filter-vorgang', 'vorgang');
            bind('filter-customer', 'customer');
            bind('filter-entryDate', 'entryDate');
            bind('filter-subject', 'subject');
            bind('filter-serialNumber', 'serialNumber');

            document.querySelectorAll('#orders-container th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const k = th.getAttribute('data-key');
                    if (!k) return;
                    if (ordersListState.sortKey === k) {
                        ordersListState.sortDir = ordersListState.sortDir === 'asc' ? 'desc' : 'asc';
                    } else {
                        ordersListState.sortKey = k;
                        ordersListState.sortDir = (k === 'entryDate') ? 'desc' : 'asc';
                    }
                    applyFiltersAndRender();
                });
            });

            updateSortIndicators();
        }

        function renderOrdersTable(orders) {
            const ordersBody = document.getElementById('orders-body');
            const emptyState = document.getElementById('empty-orders');

            if (!orders || orders.length === 0) {
                ordersBody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            ordersBody.innerHTML = '';

            orders.forEach(order => {
                const prog = getProgress(order);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight: bold; color: var(--primary-blue);">${order.vorgang}</td>
                    <td>${order.customer}</td>
                    <td>${order.entryDate ? new Date(order.entryDate).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric'}) : '-'}</td>
                    <td>${order.subject}</td>
                    <td>${order.serialNumber || ''}</td>
                    <td>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: ${prog.pct}%">${prog.pct}%</div>
                        </div>
                        <div class="progress-text">${prog.text}</div>
                    </td>
                    <td>
                        <div class="status-checkboxes">
                            <label class="status-checkbox-label"><input type="checkbox" ${order.status?.auftragErteilt ? 'checked' : ''} onchange="updateOrderStatus('${order.id}', 'auftragErteilt', this.checked)"> <span>Auftrag erteilt</span></label>
                            <label class="status-checkbox-label"><input type="checkbox" ${order.status?.reparaturAbgeschlossen ? 'checked' : ''} onchange="updateOrderStatus('${order.id}', 'reparaturAbgeschlossen', this.checked)"> <span>Abgeschlossen</span></label>
                            <label class="status-checkbox-label"><input type="checkbox" ${order.status?.versendetAnKunden ? 'checked' : ''} onchange="updateOrderStatus('${order.id}', 'versendetAnKunden', this.checked)"> <span>Versendet</span></label>
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            <button class="edit-btn" onclick="editOrder('${order.id}')">Laden</button>
                            <button class="delete-btn" onclick="deleteOrder('${order.id}')">X</button>
                        </div>
                    </td>
                `;
                ordersBody.appendChild(tr);
            });
        }

        window.updateOrderStatus = async function(orderId, type, checked) {
            const idx = ordersDatabase.findIndex(o => String(o.id) === String(orderId));
            if (idx !== -1) {
                if(!ordersDatabase[idx].status) ordersDatabase[idx].status = {};
                ordersDatabase[idx].status[type] = checked;
                
                // Direkt zu Google Sheets speichern
                await saveOrderToGoogleSheets(ordersDatabase[idx]);
                await loadOrdersList();
            }
        };
        
        window.editOrder = function(id) {
            const order = ordersDatabase.find(o => String(o.id) === String(id));
            if (!order) {
                alert("Auftrag nicht gefunden!");
                return;
            }
            
            // Basis-Formular befüllen
            document.getElementById('order-id').value = order.id;
            document.getElementById('vorgang').value = order.vorgang || '';
            document.getElementById('customer').value = order.customer || '';
            document.getElementById('entry-date').value = order.entryDate || '';
            document.getElementById('subject').value = order.subject || '';
            document.getElementById('serial-number').value = order.serialNumber || '';
            document.getElementById('name').value = order.name || '';
            document.getElementById('hours').value = order.hours || 0;
            document.getElementById('error-description').value = order.errorDescription || '';
            document.getElementById('work-todo').value = order.workTodo || '';
            
            // Zubehör laden
            if (order.accessories) {
                document.getElementById('zubehoer-hintere-kamera').checked = order.accessories.hintereKamera || false;
                document.getElementById('zubehoer-drehkamera').checked = order.accessories.drehkamera || false;
                document.getElementById('zubehoer-steuerkoffer').checked = order.accessories.steuerkoffer || false;
                document.getElementById('zubehoer-sonstiges').value = order.accessories.sonstiges || '';
            }
            
            // Funktionsüberprüfung laden
            if (order.functionTests) {
                document.getElementById('funktion-fahren').checked = order.functionTests.fahren || false;
                document.getElementById('funktion-heben').checked = order.functionTests.heben || false;
                document.getElementById('funktion-drehen').checked = order.functionTests.drehen || false;
                document.getElementById('funktion-fraeskopf-schwenken').checked = order.functionTests.fraeskopfSchwenken || false;
                document.getElementById('funktion-fraesen').checked = order.functionTests.fraesen || false;
                document.getElementById('funktion-spuelen').checked = order.functionTests.spuelen || false;
                document.getElementById('funktion-bild-hintere').checked = order.functionTests.bildHintere || false;
                document.getElementById('funktion-led-hintere').checked = order.functionTests.ledHintere || false;
                document.getElementById('funktion-bild-dreh').checked = order.functionTests.bildDreh || false;
                document.getElementById('funktion-led-dreh').checked = order.functionTests.ledDreh || false;
                document.getElementById('funktion-kamera-umschalten').checked = order.functionTests.kameraUmschalten || false;
            }
            
            // Abnahmeprotokoll laden
            if (order.acceptanceProtocol) {
                document.getElementById('abnahme-dichtigkeit').checked = order.acceptanceProtocol.dichtigkeitstest || false;
                document.getElementById('abnahme-fahren').checked = order.acceptanceProtocol.fahrenGetestet || false;
                document.getElementById('abnahme-drehen').checked = order.acceptanceProtocol.drehenGetestet || false;
                document.getElementById('abnahme-heben').checked = order.acceptanceProtocol.hebenGetestet || false;
                document.getElementById('abnahme-fraesen-real').checked = order.acceptanceProtocol.fraesenReal || false;
                document.getElementById('abnahme-pruefdatum').value = order.acceptanceProtocol.pruefdatum || '';
                document.getElementById('abnahme-pruefer').value = order.acceptanceProtocol.pruefer || '';
                document.getElementById('abnahme-anmerkungen').value = order.acceptanceProtocol.anmerkungen || '';
            }
            
            // Arbeitsaufgaben-Checkboxen aktualisieren
            // WICHTIG: Erst updateDynamicCheckboxes() aufrufen, damit die Checkboxen erstellt werden
            updateDynamicCheckboxes();
            
            // Dann mit setTimeout sicherstellen, dass DOM aktualisiert ist
            setTimeout(() => {
                if (order.workTasks) {
                    order.workTasks.forEach((t, i) => {
                        const cb = document.getElementById(`task-${i}`);
                        if (cb) {
                            cb.checked = t.completed;
                            if (t.completed) {
                                cb.closest('.task-checkbox-item').classList.add('completed');
                            }
                        }
                    });
                }
            }, 50); // Kleine Verzögerung, damit DOM aktualisiert ist
            
            // Ersatzteile befüllen
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            if (order.parts && order.parts.length > 0) {
                order.parts.forEach(part => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td><input type="text" value="${part.articleNumber || ''}"></td>
                        <td><input type="text" value="${part.description || ''}"></td>
                        <td><input type="text" value="${part.quantity || ''}"></td>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>';
            }
            
            // Ansicht wechseln
            document.getElementById('orders-container').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
            window.scrollTo(0,0);
        };
        
        window.deleteOrder = async function(id) {
            if (!confirm('Auftrag wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden!')) {
                return;
            }
            
            // HINWEIS: Zum Löschen in Google Sheets müssten Sie Ihr Google Apps Script erweitern
            // Aktuell wird nur lokal aus dem Cache gelöscht
            alert('HINWEIS: Das Löschen aus Google Sheets ist noch nicht implementiert.\n\nBitte löschen Sie den Eintrag manuell in Ihrem Google Sheet.');
            
            // Lokal entfernen
            ordersDatabase = ordersDatabase.filter(o => String(o.id) !== String(id));
            applyFiltersAndRender();
        };
        
        function resetForm() {
            document.getElementById('order-id').value = '';
            document.getElementById('vorgang').value = '';
            document.getElementById('customer').value = '';
            document.getElementById('subject').value = '';
            document.getElementById('serial-number').value = '';
            document.getElementById('name').value = '';
            document.getElementById('hours').value = '';
            document.getElementById('error-description').value = '';
            document.getElementById('work-todo').value = '';
            document.getElementById('work-tasks-container').style.display = 'none';
            document.getElementById('table-body').innerHTML = '<tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>';
            
            // Neue Felder zurücksetzen
            document.getElementById('zubehoer-hintere-kamera').checked = false;
            document.getElementById('zubehoer-drehkamera').checked = false;
            document.getElementById('zubehoer-steuerkoffer').checked = false;
            document.getElementById('zubehoer-sonstiges').value = '';
            
            document.getElementById('funktion-fahren').checked = false;
            document.getElementById('funktion-heben').checked = false;
            document.getElementById('funktion-drehen').checked = false;
            document.getElementById('funktion-fraeskopf-schwenken').checked = false;
            document.getElementById('funktion-fraesen').checked = false;
            document.getElementById('funktion-spuelen').checked = false;
            document.getElementById('funktion-bild-hintere').checked = false;
            document.getElementById('funktion-led-hintere').checked = false;
            document.getElementById('funktion-bild-dreh').checked = false;
            document.getElementById('funktion-led-dreh').checked = false;
            document.getElementById('funktion-kamera-umschalten').checked = false;
            
            // Abnahmeprotokoll zurücksetzen
            document.getElementById('abnahme-dichtigkeit').checked = false;
            document.getElementById('abnahme-fahren').checked = false;
            document.getElementById('abnahme-drehen').checked = false;
            document.getElementById('abnahme-heben').checked = false;
            document.getElementById('abnahme-fraesen-real').checked = false;
            document.getElementById('abnahme-pruefdatum').value = '';
            document.getElementById('abnahme-pruefer').value = '';
            document.getElementById('abnahme-anmerkungen').value = '';
            
            updateDynamicCheckboxes();
        }
        
        // ============================================
        // PDF GENERIERUNG
        // ============================================
        
        async function generatePDF(orderData) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Helper-Funktion für Checkboxen
            const checkMark = (value) => value ? '☑' : '☐';
            
            // SEITE 1: Auftragsstammdaten, Fehlerbeschreibung, Arbeitsaufgaben (OHNE workTodo Textbox!)
            const page1Content = `
                <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 30px; font-size: 11px; background: #ffffff;">
                    <!-- HEADER -->
                    <div style="background: linear-gradient(to right, #005293, #007bc0); color: white; padding: 25px; margin: -30px -30px 25px -30px; border-radius: 0;">
                        <div style="display: flex; align-items: center; justify-content: center;">
                            <div style="text-align: center;">
                                <h1 style="font-size: 28px; margin: 0 0 8px 0; font-weight: 700;">IBG HYDROTECH</h1>
                                <p style="font-size: 16px; margin: 0; opacity: 0.95;">Reparaturprotokoll - Fräsroboter-Service</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AUFTRAGSSTAMMDATEN -->
                    <div style="margin-bottom: 25px;">
                        <h2 style="color: #005293; font-size: 18px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 3px solid #e37222; font-weight: 700;">
                            📋 Auftragsstammdaten
                        </h2>
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; background: #f5f5f5; border-radius: 8px;">
                            <tr style="border-bottom: 1px solid #e0e0e0;">
                                <td style="padding: 10px 15px; width: 35%; font-weight: bold; color: #005293;">Vorgang:</td>
                                <td style="padding: 10px 15px; color: #333;">${orderData.vorgang || '-'}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e0e0e0; background: white;">
                                <td style="padding: 10px 15px; font-weight: bold; color: #005293;">Kunde:</td>
                                <td style="padding: 10px 15px; color: #333;">${orderData.customer || '-'}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e0e0e0;">
                                <td style="padding: 10px 15px; font-weight: bold; color: #005293;">Eingangsdatum:</td>
                                <td style="padding: 10px 15px; color: #333;">${orderData.entryDate || '-'}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e0e0e0; background: white;">
                                <td style="padding: 10px 15px; font-weight: bold; color: #005293;">Betrifft:</td>
                                <td style="padding: 10px 15px; color: #333;">${orderData.subject || '-'}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e0e0e0;">
                                <td style="padding: 10px 15px; font-weight: bold; color: #005293;">Seriennummer:</td>
                                <td style="padding: 10px 15px; color: #333;">${orderData.serialNumber || '-'}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e0e0e0; background: white;">
                                <td style="padding: 10px 15px; font-weight: bold; color: #005293;">Bearbeiter:</td>
                                <td style="padding: 10px 15px; color: #333;">${orderData.name || '-'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px 15px; font-weight: bold; color: #005293;">Stunden:</td>
                                <td style="padding: 10px 15px; color: #333;">${orderData.hours || 0}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- ZUBEHÖR -->
                    <div style="background: #f0f2f5; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #e37222;">
                        <h3 style="color: #005293; font-size: 14px; margin: 0 0 10px 0; font-weight: 700;">📦 Mitgeliefertes Zubehör</h3>
                        <p style="margin: 5px 0; color: #333; line-height: 1.8;">
                            <span style="background: ${orderData.accessories?.hintereKamera ? '#d4edda' : '#f8f9fa'}; padding: 4px 10px; border-radius: 4px; margin-right: 8px; display: inline-block; margin-bottom: 5px;">
                                ${checkMark(orderData.accessories?.hintereKamera)} Hintere Kamera
                            </span>
                            <span style="background: ${orderData.accessories?.drehkamera ? '#d4edda' : '#f8f9fa'}; padding: 4px 10px; border-radius: 4px; margin-right: 8px; display: inline-block; margin-bottom: 5px;">
                                ${checkMark(orderData.accessories?.drehkamera)} Drehkamera
                            </span>
                            <span style="background: ${orderData.accessories?.steuerkoffer ? '#d4edda' : '#f8f9fa'}; padding: 4px 10px; border-radius: 4px; display: inline-block; margin-bottom: 5px;">
                                ${checkMark(orderData.accessories?.steuerkoffer)} Steuerkoffer
                            </span>
                        </p>
                        ${orderData.accessories?.sonstiges ? `<p style="margin: 10px 0 0 0; color: #333;"><strong>Sonstiges:</strong> ${orderData.accessories.sonstiges}</p>` : ''}
                    </div>
                    
                    <!-- FEHLERANALYSE -->
                    <div style="margin-bottom: 25px;">
                        <h2 style="color: #005293; font-size: 18px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 3px solid #e37222; font-weight: 700;">
                            ⚠️ Fehleranalyse
                        </h2>
                        
                        <h3 style="color: #005293; font-size: 14px; margin-bottom: 10px; font-weight: 700;">✓ Funktionsüberprüfung bei Annahme</h3>
                        <div style="background: #f0f2f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <p style="margin: 5px 0; color: #333; line-height: 2;">
                                <span style="background: ${orderData.functionTests?.fahren ? '#d4edda' : '#ffffff'}; padding: 6px 12px; border-radius: 4px; margin-right: 8px; display: inline-block; margin-bottom: 6px; border: 1px solid #e0e0e0;">
                                    ${checkMark(orderData.functionTests?.fahren)} Fahren
                                </span>
                                <span style="background: ${orderData.functionTests?.heben ? '#d4edda' : '#ffffff'}; padding: 6px 12px; border-radius: 4px; margin-right: 8px; display: inline-block; margin-bottom: 6px; border: 1px solid #e0e0e0;">
                                    ${checkMark(orderData.functionTests?.heben)} Heben
                                </span>
                                <span style="background: ${orderData.functionTests?.drehen ? '#d4edda' : '#ffffff'}; padding: 6px 12px; border-radius: 4px; margin-right: 8px; display: inline-block; margin-bottom: 6px; border: 1px solid #e0e0e0;">
                                    ${checkMark(orderData.functionTests?.drehen)} Drehen
                                </span>
                                <span style="background: ${orderData.functionTests?.fraeskopfSchwenken ? '#d4edda' : '#ffffff'}; padding: 6px 12px; border-radius: 4px; margin-right: 8px; display: inline-block; margin-bottom: 6px; border: 1px solid #e0e0e0;">
                                    ${checkMark(orderData.functionTests?.fraeskopfSchwenken)} Fräskopf schwenken
                                </span>
                                <span style="background: ${orderData.functionTests?.fraesen ? '#d4edda' : '#ffffff'}; padding: 6px 12px; border-radius: 4px; margin-right: 8px; display: inline-block; margin-bottom: 6px; border: 1px solid #e0e0e0;">
                                    ${checkMark(orderData.functionTests?.fraesen)} Fräsen
                                </span>
                                <span style="background: ${orderData.functionTests?.spuelen ? '#d4edda' : '#ffffff'}; padding: 6px 12px; border-radius: 4px; display: inline-block; margin-bottom: 6px; border: 1px solid #e0e0e0;">
                                    ${checkMark(orderData.functionTests?.spuelen)} Spülen
                                </span>
                            </p>
                        </div>
                        
                        ${(orderData.functionTests?.bildHintere || orderData.functionTests?.ledHintere || 
                           orderData.functionTests?.bildDreh || orderData.functionTests?.ledDreh || 
                           orderData.functionTests?.kameraUmschalten) ? `
                        <h4 style="color: #005293; font-size: 12px; margin: 15px 0 10px 0; font-weight: 700;">📹 Kamera-Funktionen</h4>
                        <div style="background: #f0f2f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <p style="margin: 5px 0; color: #333; line-height: 2;">
                                <span style="background: ${orderData.functionTests?.bildHintere ? '#d4edda' : '#ffffff'}; padding: 6px 12px; border-radius: 4px; margin-right: 8px; display: inline-block; margin-bottom: 6px; border: 1px solid #e0e0e0;">
                                    ${checkMark(orderData.functionTests?.bildHintere)} Bild hintere Kamera
                                </span>
                                <span style="background: ${orderData.functionTests?.ledHintere ? '#d4edda' : '#ffffff'}; padding: 6px 12px; border-radius: 4px; margin-right: 8px; display: inline-block; margin-bottom: 6px; border: 1px solid #e0e0e0;">
                                    ${checkMark(orderData.functionTests?.ledHintere)} LED hintere Kamera
                                </span>
                                <span style="background: ${orderData.functionTests?.bildDreh ? '#d4edda' : '#ffffff'}; padding: 6px 12px; border-radius: 4px; margin-right: 8px; display: inline-block; margin-bottom: 6px; border: 1px solid #e0e0e0;">
                                    ${checkMark(orderData.functionTests?.bildDreh)} Bild Drehkamera
                                </span>
                                <span style="background: ${orderData.functionTests?.ledDreh ? '#d4edda' : '#ffffff'}; padding: 6px 12px; border-radius: 4px; margin-right: 8px; display: inline-block; margin-bottom: 6px; border: 1px solid #e0e0e0;">
                                    ${checkMark(orderData.functionTests?.ledDreh)} LED Drehkamera
                                </span>
                                <span style="background: ${orderData.functionTests?.kameraUmschalten ? '#d4edda' : '#ffffff'}; padding: 6px 12px; border-radius: 4px; display: inline-block; margin-bottom: 6px; border: 1px solid #e0e0e0;">
                                    ${checkMark(orderData.functionTests?.kameraUmschalten)} Kamerabild umschalten
                                </span>
                            </p>
                        </div>` : ''}
                        
                        <h3 style="color: #005293; font-size: 14px; margin: 15px 0 10px 0; font-weight: 700;">📝 Fehlerbeschreibung</h3>
                        <div style="border: 2px solid #e37222; padding: 15px; background: #fffbf5; border-radius: 8px; margin-bottom: 15px;">
                            <p style="margin: 0; color: #333; line-height: 1.6; white-space: pre-wrap;">${orderData.errorDescription || '-'}</p>
                        </div>
                    </div>
                    
                    <!-- ARBEITSAUFGABEN -->
                    <div style="margin-bottom: 20px;">
                        <h2 style="color: #005293; font-size: 18px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 3px solid #e37222; font-weight: 700;">
                            🔧 Arbeitsaufgaben
                        </h2>
                        
                        ${orderData.workTasks && orderData.workTasks.length > 0 ? `
                        <div style="background: #f0f2f5; padding: 15px; border-radius: 8px; border-left: 4px solid #007bc0;">
                            <ul style="margin: 0; padding-left: 25px; color: #333; line-height: 2;">
                                ${orderData.workTasks.map(task => `
                                    <li style="margin: 8px 0; ${task.completed ? 'text-decoration: line-through; color: #28a745; font-weight: 600;' : ''}">
                                        <span style="background: ${task.completed ? '#d4edda' : '#ffffff'}; padding: 4px 10px; border-radius: 4px; display: inline-block; border: 1px solid ${task.completed ? '#28a745' : '#e0e0e0'};">
                                            ${checkMark(task.completed)} ${task.task}
                                        </span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>` : '<p style="color: #666; font-style: italic; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center;">Keine Arbeitsaufgaben definiert.</p>'}
                    </div>
                </div>
            `;
            
            // Rendern der ersten Seite
            const temp1 = document.createElement('div');
            temp1.innerHTML = page1Content;
            temp1.style.width = '210mm';
            document.body.appendChild(temp1);
            const canvas1 = await html2canvas(temp1, { scale: 2 });
            document.body.removeChild(temp1);
            
            const imgData1 = canvas1.toDataURL('image/png');
            const imgWidth = 190;
            const imgHeight = (canvas1.height * imgWidth) / canvas1.width;
            doc.addImage(imgData1, 'PNG', 10, 10, imgWidth, imgHeight);
            
            // SEITE 2: Ersatzteile / Abnahmeprotokoll (mit Seitenumbruch)
            const ap = orderData.acceptanceProtocol || {};
            const hasAp = Object.values(ap).some(v => v === true || (typeof v === 'string' && v.trim() !== ''));
            if ((orderData.parts && orderData.parts.length > 0) || hasAp) {
                doc.addPage();
                
                const page2Content = `
                    <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 30px; font-size: 11px; background: #ffffff;">
                        <!-- HEADER -->
                        <div style="background: linear-gradient(to right, #005293, #007bc0); color: white; padding: 25px; margin: -30px -30px 25px -30px; border-radius: 0;">
                            <div style="display: flex; align-items: center; justify-content: center;">
                                <div style="text-align: center;">
                                    <h1 style="font-size: 28px; margin: 0 0 8px 0; font-weight: 700;">IBG HYDROTECH</h1>
                                    <p style="font-size: 16px; margin: 0; opacity: 0.95;">Reparaturprotokoll - Fräsroboter-Service</p>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #f0f2f5; padding: 12px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #e37222;">
                            <p style="margin: 0; font-size: 13px;"><strong style="color: #005293;">Vorgang:</strong> <span style="color: #333;">${orderData.vorgang || '-'}</span></p>
                        </div>
                        
                        <!-- ERSATZTEILE -->
                        <div style="margin-bottom: 25px;">
                            <h2 style="color: #005293; font-size: 18px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 3px solid #e37222; font-weight: 700;">
                                ⚙️ Benötigte Ersatzteile
                            </h2>
                            ${orderData.parts && orderData.parts.length > 0 ? `
                            <table style="width: 100%; border-collapse: collapse; border: 2px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                                <thead>
                                    <tr style="background: linear-gradient(to right, #005293, #007bc0); color: white;">
                                        <th style="padding: 12px; text-align: left; font-weight: 700;">Artikelnummer</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 700;">Beschreibung</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 700;">Menge</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${orderData.parts.map((part, index) => `
                                        <tr style="background: ${index % 2 === 0 ? '#ffffff' : '#f5f5f5'}; border-bottom: 1px solid #e0e0e0;">
                                            <td style="padding: 10px 12px; color: #333;">${part.articleNumber || '-'}</td>
                                            <td style="padding: 10px 12px; color: #333;">${part.description || '-'}</td>
                                            <td style="padding: 10px 12px; color: #333; font-weight: 600;">${part.quantity || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>` : `<p style="margin: 5px 0; color: #666; font-style: italic; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center;">Keine Ersatzteile erfasst.</p>`}
                        </div>

                        <!-- ABNAHMEPROTOKOLL -->
                        <div style="margin-bottom: 20px;">
                            <h2 style="color: #005293; font-size: 18px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 3px solid #e37222; font-weight: 700;">
                                ✅ Abnahmeprotokoll vor Auslieferung
                            </h2>
                            <div style="background: #f0f2f5; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                                <p style="margin: 5px 0; color: #333; line-height: 2;">
                                    <span style="background: ${ap.dichtigkeitstest ? '#d4edda' : '#ffffff'}; padding: 6px 12px; border-radius: 4px; margin-right: 8px; display: inline-block; margin-bottom: 6px; border: 1px solid #e0e0e0;">
                                        ${checkMark(ap.dichtigkeitstest)} Dichtigkeitstest im Wasserbad
                                    </span><br>
                                    <span style="background: ${ap.fahrenGetestet ? '#d4edda' : '#ffffff'}; padding: 6px 12px; border-radius: 4px; margin-right: 8px; display: inline-block; margin-bottom: 6px; border: 1px solid #e0e0e0;">
                                        ${checkMark(ap.fahrenGetestet)} Fahren getestet
                                    </span><br>
                                    <span style="background: ${ap.drehenGetestet ? '#d4edda' : '#ffffff'}; padding: 6px 12px; border-radius: 4px; margin-right: 8px; display: inline-block; margin-bottom: 6px; border: 1px solid #e0e0e0;">
                                        ${checkMark(ap.drehenGetestet)} Drehen getestet
                                    </span><br>
                                    <span style="background: ${ap.hebenGetestet ? '#d4edda' : '#ffffff'}; padding: 6px 12px; border-radius: 4px; margin-right: 8px; display: inline-block; margin-bottom: 6px; border: 1px solid #e0e0e0;">
                                        ${checkMark(ap.hebenGetestet)} Heben getestet
                                    </span><br>
                                    <span style="background: ${ap.fraesenReal ? '#d4edda' : '#ffffff'}; padding: 6px 12px; border-radius: 4px; display: inline-block; margin-bottom: 6px; border: 1px solid #e0e0e0;">
                                        ${checkMark(ap.fraesenReal)} Unter realen Bedingungen gefräst
                                    </span>
                                </p>
                            </div>
                        </div>
                        
                        ${ap.pruefdatum || ap.pruefer || ap.anmerkungen ? `
                        <div style="margin-top: 20px;">
                            <h3 style="color: #005293; font-size: 14px; margin-bottom: 10px; font-weight: 700;">📋 Prüfdetails</h3>
                            <table style="width: 100%; border-collapse: collapse; background: #f5f5f5; border-radius: 8px;">
                                ${ap.pruefdatum ? `
                                <tr style="border-bottom: 1px solid #e0e0e0;">
                                    <td style="padding: 10px 15px; width: 30%; font-weight: bold; color: #005293;">Prüfdatum:</td>
                                    <td style="padding: 10px 15px; color: #333;">${ap.pruefdatum}</td>
                                </tr>` : ''}
                                ${ap.pruefer ? `
                                <tr style="border-bottom: 1px solid #e0e0e0; background: white;">
                                    <td style="padding: 10px 15px; font-weight: bold; color: #005293;">Prüfer:</td>
                                    <td style="padding: 10px 15px; color: #333;">${ap.pruefer}</td>
                                </tr>` : ''}
                                ${ap.anmerkungen ? `
                                <tr>
                                    <td style="padding: 10px 15px; font-weight: bold; color: #005293; vertical-align: top;">Anmerkungen:</td>
                                    <td style="padding: 10px 15px; color: #333;">${ap.anmerkungen}</td>
                                </tr>` : ''}
                            </table>
                        </div>` : ''}
                    </div>
                `;
                
                const temp2 = document.createElement('div');
                temp2.innerHTML = page2Content;
                temp2.style.width = '210mm';
                document.body.appendChild(temp2);
                const canvas2 = await html2canvas(temp2, { scale: 2 });
                document.body.removeChild(temp2);
                
                const imgData2 = canvas2.toDataURL('image/png');
                const imgHeight2 = (canvas2.height * imgWidth) / canvas2.width;
                doc.addImage(imgData2, 'PNG', 10, 10, imgWidth, imgHeight2);
            }
            
            doc.save(`Reparatur_${orderData.vorgang}.pdf`);
        }
        
        // ============================================
        // INITIALISIERUNG
        // ============================================
        
        window.addEventListener('DOMContentLoaded', () => {
            initOrdersListControls();
            
            // Setze heutiges Datum als Standard
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('entry-date').value = today;
            
            // Lade initial die Aufträge (falls URL konfiguriert ist)
            if (GOOGLE_SCRIPT_URL && GOOGLE_SCRIPT_URL !== 'HIER_IHRE_GOOGLE_SCRIPT_URL') {
                loadOrdersList();
            }
        });
    </script>
</body>
</html>
